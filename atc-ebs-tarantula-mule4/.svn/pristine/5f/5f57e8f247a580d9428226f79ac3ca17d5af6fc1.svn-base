<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd 
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	
	<flow name="ControlFlow-Read-LastRunDateFlow" doc:id="26c7c26c-a62d-4261-88c9-e3b5627e677c" >
		<logger level="INFO" doc:name="Logger" doc:id="23bb00ee-7d25-4d11-99eb-f746daa77276" message="-----ControlFlow-Read-LastRunDateFlow------"/>
		<db:select doc:name="Select" doc:id="c9d12cb6-d9c5-4bf1-841f-fd8e5a715370" config-ref="Oracle_Configuration">
			<db:sql >SELECT INTERFACE_NAME, LAST_RUN_DATE  from XXATC.ATC_IND_SVCS_CONTROL_TBL where INTERFACE_NAME=:flowName</db:sql>
			<db:input-parameters ><![CDATA[#[{
  flowName : vars.flowName
}]]]></db:input-parameters>
		</db:select>
		<set-variable value='#[payload[0].LAST_RUN_DATE as DateTime {format: "MM-dd-yyyy  HH:mm:ss" }  as String {format : "dd-MMM-yyyy HH:mm:ss"}]' doc:name="Set lastRunDate" doc:id="58b1da5e-2a9c-4d55-b65b-2475f5c08f3e" variableName="lastRunDate"/>
		<logger level="INFO" doc:name="Logger" doc:id="8ef3066b-faac-4969-b3e5-fa8e0adbefe1" message='#["Last Run date for the flow " ++ vars.flowName default "" ++  " is : " ++ vars.lastRunDate default ""]'/>
	</flow>
	
	<flow name="fetchAll-data-logicFlow" doc:id="5e0c35d7-f411-4587-b3af-56a4b4b30037" >
		<db:select doc:name="Select" doc:id="cf5fce53-3561-42be-aaf8-ff254d7c258e" config-ref="Oracle_Configuration">
			<db:sql >select INTERFACE_NAME,LAST_RUN_DATE from xxatc.ATC_IND_SVCS_CONTROL_TBL</db:sql>
		</db:select>
		<ee:transform doc:name="Transform Message" doc:id="9b4e81d8-1916-49e1-86fa-cfbc47743414" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="b37a5e52-eecd-4b14-bb4c-5f155ef60516" message='#["End of GET control Table Flow :"++ write(payload,"application/json")]'/>
	</flow>
	<flow name="common-Generate-Batch-Number-subFlow" doc:id="f640ac63-a068-418f-88d1-f6857f8a8cc9" >
		<logger level="INFO" doc:name="Logger" doc:id="4e90149c-4a8e-4bcb-bd55-06057c90bfb9" message="------common-Generate-Batch-Number-subFlow-------"/>
		<db:select doc:name="Select" doc:id="0df4ecd3-037c-4c66-ba5d-130dc7a85065" config-ref="Oracle_Configuration">
			<db:sql >select xxatc.atc_ind_svcs_util_pkg.generate_batch_number(:flowName) &quot;batchNumber&quot; from dual</db:sql>
			<db:input-parameters ><![CDATA[#[{
flowName : vars.flowName
}]]]></db:input-parameters>
		</db:select>
	</flow>
	
	<flow name="ControlTable-Update-subFlow" doc:id="de43d7b3-672b-41d9-99e1-0c87d9a81f41" >
		<logger level="INFO" doc:name="Log updating control table" doc:id="05874328-e82e-4cd1-9da8-e322d1691db1" message="------------------Updating Last Run Date-------------------"/>
		<ee:transform doc:name="Transform Message" doc:id="646c0fe9-41d3-4368-84c2-7c2b53490e32" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
	flowName : vars.flowName,
	lastRunDate : vars.lastUpdateDate 
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<db:update doc:name="Update" doc:id="ad6b2868-864f-42d0-8c47-b3745687558a" config-ref="Oracle_Configuration">
			<db:sql >update XXATC.ATC_IND_SVCS_CONTROL_TBL set LAST_RUN_DATE=TO_DATE(:lastRunDate,'DD-MM-YYYY HH24:MI:SS') where INTERFACE_NAME=:flowName </db:sql>
			<db:input-parameters ><![CDATA[#[{
	"lastRunDate" : payload.lastRunDate,
	"flowName" : payload.flowName
}]]]></db:input-parameters>
		</db:update>
		<logger level="INFO" doc:name="Logger" doc:id="4801b521-1791-4d22-b1f5-8ff0f96a0365" message="Log Update successful"/>
	</flow>
	
	</mule>
