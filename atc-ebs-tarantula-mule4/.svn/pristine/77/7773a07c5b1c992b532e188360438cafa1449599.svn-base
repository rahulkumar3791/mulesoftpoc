<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http" 
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:sftp="http://www.mulesoft.org/schema/mule/sftp" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/sftp http://www.mulesoft.org/schema/mule/sftp/current/mule-sftp.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">
	<flow name="purchase-requisition-retry-mainFlow" doc:id="9d06f52c-f47a-49e1-88e7-891240285a6c" >
		<logger level="INFO" doc:name="Logger" doc:id="a288bbef-3cce-4fae-836e-828dffe73a7f" message="#########purchase-requistion-retry flow is started ##########"/>
		<ee:transform doc:name="variable Initialize" doc:id="a746042c-e43e-4698-a4c0-af66a74bb8a0" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="ip" ><![CDATA[server.ip as String default "0.0.0.0"]]></ee:set-variable>
				<ee:set-variable variableName="flowName" ><![CDATA["TT_PR_DETAILS"]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Purchase-Requistion-Retry-MainLogicFlow" doc:id="cefd35dd-cdab-4b06-8dbf-4293c9ff70a4" name="Purchase-Requistion-Retry-MainLogicFlow" />
		<logger level="INFO" doc:name="Logger" doc:id="ecad3338-67dd-44ca-ab91-27513062b8c1" message="##############purchase-requistion-retry flow is Completed ############"/>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="0face82f-7db4-4bce-9995-ebb6debec773" type="ANY">
				<set-variable value="#[error.detailedDescription]" doc:name="Set errorMsg" doc:id="4894fdb5-e62b-4e07-bd8d-2f2f3366506b" variableName="errorMsg"/>
				<logger level="INFO" doc:name="Error Log" doc:id="67e2b8df-8342-4479-bea9-8119b53738d6" message="#[vars.errorMsg]"/>
				<set-variable value='#["Failed"]' doc:name="Set Status" doc:id="6ba6d45d-fa1a-4b3a-afc1-099b85826a2e" variableName="status"/>
				<ee:transform doc:name="Email-Audit Payload" doc:id="0b10f922-f7a0-4a4b-8d46-45501cc1b4a0" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
   
   "service": p('current.project.name'),
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":p('interface.id.purchase.requisition') ,
   "interface_type": p('current.project.type'),
   "requester_ip" : vars.ip,
   "data": {
   	      "status": vars.status,
   	      "flowName": "Purchase requisition : Oracle to TARANTULA",
          "error" : vars.errorMsg
         }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="send-email-audit-Flow" doc:id="13755d4f-015f-447c-aa19-9211f8df9607" name="send-email-audit-Flow"/>
			</on-error-propagate>
		</error-handler>
	</flow>
	<flow name="Purchase-Requistion-Retry-MainLogicFlow" doc:id="f8dd7cf8-9793-4052-9e9e-7a055df42f1e" >
		<db:select doc:name="Read Data from TT stagging table" doc:id="3b91bed5-706f-4d96-814e-db17b01f0c24" config-ref="Email_Audit_Database_Config">
			<db:sql>SELECT PRNUMBER,LINEID,RETRYCOUNT from atc_tt_stagging where JOBSTATUS=:jobStatus and  FLOWNAME=:flowName</db:sql>
			<db:input-parameters><![CDATA[#[{
	"jobStatus" : 'Failed',
	"flowName" : vars.flowName
}]]]></db:input-parameters>
		</db:select>
		<choice doc:name="Choice" doc:id="910b98d0-178f-47d3-ae0d-c2fbe6120492" >
			<when expression="#[sizeOf(payload) &gt; 0]">
				<flow-ref doc:name="Purachese-Requisition-Retry-ReadFromOracle-subFlow" doc:id="2371fe09-0bd9-4a76-a900-44ca421caa87" name="Purachese-Requisition-Retry-ReadFromOracle-subFlow"/>
				<set-variable value='#["success"]' doc:name="Set Status" doc:id="d2c62da9-277f-4cd2-85d3-02ff528d3af9" variableName="status" />
				<ee:transform doc:name="Email Audit Payload" doc:id="90f839bb-ee0e-4691-844e-6aa60e2b7f44">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
   
   "service": p('current.project.name'),
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":p('interface.id.purchase.requisition') ,
   "interface_type": p('current.project.type'),
   "requester_ip" : vars.ip,
   "data": {
   	      "status": vars.status,
   	       "flowName": "Purchase requisition : Oracle to TARANTULA",
          "recordsProcessed" : vars.totalRecords,
          "currentLastRunDate" : vars.lastUpdateDate,
          "batchNumber": vars.batchDetails.batchNumber,
          "successList" : vars.successList default [],
          "failedList" : vars.failedList default []
         }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="send-email-audit-Flow" doc:id="5b5a53c4-62a3-48b8-a1ff-c67f395f6ab2" name="send-email-audit-Flow" />
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Log No updated records" doc:id="e95c7874-f363-4b1d-8050-7a70d9c1f4a7" message="################## No Updated Records available #############"/>
			</otherwise>
		</choice>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="16d33741-9c41-4317-adba-e9235d7aaaaf" >
				<logger level="INFO" doc:name="Logger" doc:id="bf0c9575-fa17-4880-af15-0f2972e93706" message="#[error.detailedDescription]"/>
			</on-error-propagate>
		</error-handler>
	</flow>
	<flow name="Purachese-Requisition-Retry-ReadFromOracle-subFlow" doc:id="56f0a171-8f27-49de-b6c3-403cfba0cf8f" >
		<ee:transform doc:name="Init Variables" doc:id="2e3afae5-7102-4038-9ace-4d90b80e37cd" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="totalRecords" ><![CDATA[0]]></ee:set-variable>
				<ee:set-variable variableName="successList" ><![CDATA[[]]]></ee:set-variable>
				<ee:set-variable variableName="failedList" ><![CDATA[[]]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="509381f0-e7d4-4746-819f-902cdd4dcbb7" message=" ---------------- DataSync from Oracle to TT Purchase Requisition retryFlow----------------------"/>
		<foreach doc:name="For Each" doc:id="4ae4404b-f65b-46cb-9565-0247b721f888">
			<ee:transform doc:name="Set Variables" doc:id="a4dd95d0-f880-432c-9a26-b272d79e69c3" >
				<ee:message >
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="PRNUMBER" ><![CDATA[%dw 2.0
output application/java
---
payload.PRNUMBER]]></ee:set-variable>
					<ee:set-variable variableName="LINEID" ><![CDATA[%dw 2.0
output application/java
---
payload.LINEID]]></ee:set-variable>
					<ee:set-variable variableName="RETRYCOUNT" ><![CDATA[%dw 2.0
output application/java
---
payload.RETRYCOUNT default 0]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<db:select doc:name="Read Data from Oracle" doc:id="b9641965-6ef7-4b20-aca3-5cafa641d521" config-ref="Oracle_Configuration">
				<db:sql>SELECT
    PR.PR_HEADER_ID, 
    PR.PR_NUMBER,
    PR.PR_STATUS, 
    PR.PR_DESCRIPTION,TTID, 
    PR.PR_LINE_ID,
    PR.PR_LINE_NUMBER,
    PR.PR_LINE_STATUS,
    PR.ITEM_CODE, 
    PR.ITEM_DESCRIPTION, 
    DECODE(PR.ITEM_CATEGORY, 'Airconditioner' , DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'Battery Bank', 
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'DG',
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'Shelter' , 
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'SMPS' , 
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'TOWER' , 
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    PR.ITEM_CATEGORY) &quot;ITEM_CATEGORY&quot;,
    PR.UOM_CODE, 
    to_char(PR.NEED_BY_DATE,'yyyy-mm-dd HH24:MI:SS') &quot;NEED_BY_DATE&quot;,
    PR.QUANTITY,
    PRICE, 
    PR.LINE_VALUE ,
    PR.PROJECT_NAME,
    PR.SUPPLIER_NAME,
    to_char(PR.CREATION_DATE,'yyyy-mm-dd HH24:MI:SS') &quot;CREATION_DATE&quot;,
    to_char(PR.LAST_UPDATE_DATE,'yyyy-mm-dd HH24:MI:SS') &quot;LAST_UPDATE_DATE&quot;,
    PR.PO_NUMBER,
    PR.PO_STATUS,
    PR.MO_NUMBER, 
    PR.MO_STATUS
    FROM XXATC.ATC_PO_IND_SVCS_PR_TT_V PR 
    LEFT JOIN XXATC.ATC_IND_ITEM_CODE_LOOKUP LK
    ON PR.ITEM_CODE = LK.ITEM_CODE
	WHERE PR.PR_NUMBER=:PR_NUMBER and PR.PR_LINE_ID=:PR_LINEID</db:sql>
				<db:input-parameters><![CDATA[#[{
  "PR_NUMBER" : vars.PRNUMBER,
  "PR_LINEID" : vars.LINEID,
}]]]></db:input-parameters>
			</db:select>
			<ee:transform doc:name="Transform Message" doc:id="53566978-601d-4309-9a6b-8ca8fe9aa398">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
payload map (payload01 , indexOfPayload01) -> {
		PR_HEADER_ID		:	payload01.PR_HEADER_ID,
		PR_NUMBER			: 	payload01.PR_NUMBER,
		PR_STATUS  			:	payload01.PR_STATUS,
		PR_DESCRIPTION  	:	payload01.PR_DESCRIPTION,
		TTID       			:  payload01.TTID,
		PR_LINE_ID 			:	payload01.PR_LINE_ID,
		PR_LINE_NUMBER   	:	payload01.PR_LINE_NUMBER,
		PR_LINE_STATUS   	:	payload01.PR_LINE_STATUS,
		ITEM_CODE  			:	payload01.ITEM_CODE,
		ITEM_DESCRIPTION 	:	payload01.ITEM_DESCRIPTION,
		ITEM_CATEGORY    	:	payload01.ITEM_CATEGORY,
		UOM_CODE   			:	payload01.UOM_CODE,
		NEED_BY_DATE     	:	payload01.NEED_BY_DATE,
		QUANTITY   			:	payload01.QUANTITY,
		PRICE      			:	payload01.PRICE,
		LINE_VALUE 			:	payload01.LINE_VALUE,
		PROJECT_NAME		: 	payload01.PROJECT_NAME,
		SUPPLIER_NAME    	:	payload01.SUPPLIER_NAME,
		CREATION_DATE    	:	payload01.CREATION_DATE ,
		LAST_UPDATE_DATE 	:	payload01.LAST_UPDATE_DATE,
		PO_NUMBER  			:	payload01.PO_NUMBER,
		PO_STATUS  			:	payload01.PO_STATUS,
		MO_NUMBER  			:	payload01.MO_NUMBER,
		MO_STATUS  			:	payload01.MO_STATUS
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>
			<logger level="INFO" doc:name="Log PR Numbers" doc:id="d7d58cd1-6047-4447-bce8-9af04f2b4885" message="#[output application/json --- payload.PR_NUMBER]" />
			<flow-ref doc:name="Purachese-Requisition-write-to-TT-retry-subFlow" doc:id="09e351d9-6f86-42df-a82a-6eaa0e545c04" name="Purachese-Requisition-write-to-TT-retry-subFlow" />
		</foreach>
	</flow>
	<flow name="Purachese-Requisition-write-to-TT-retry-subFlow" doc:id="f01f968a-72bf-4998-a521-70fafdc0546c" >
		<try doc:name="Try" doc:id="5d015817-e030-4c3f-8a0e-6249582d357b">
			<ee:transform doc:name="Set datFields" doc:id="2cd6d023-30f0-48c3-926c-3b9c754bf21d" >
				<ee:message >
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="dataFields" ><![CDATA[%dw 2.0
output application/java
---
{
	"PR_NUMBER" : payload.PR_NUMBER[0],
	"PR_LINE_ID" : payload.PR_LINE_ID[0],
	"PR_LINEID" : payload.PR_NUMBER[0] ++ " - " ++ payload.PR_LINE_ID[0]
}]]></ee:set-variable>
					<ee:set-variable variableName="retryCounter" ><![CDATA[%dw 2.0
output application/java
---
if(vars.RETRYCOUNT != null) (vars.RETRYCOUNT + 1) else 0]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
				<db:insert doc:name="Insert TT DB" doc:id="8702b815-c31c-4cc5-9e63-5fce11bac33d" config-ref="SQL_Server_Database_Config">
					<db:sql>INSERT INTO 
I_PR_PO(BOQId, PRLineId, PRNumber, PRStatus, PRDescription, TTID, PRLineNumber, PRLineStatus, ItemCode, ItemDescription, ItemName, UOMCode, NeedByDate, Quantity, Price, LineValue, ProjectName, Vendor, PONumber, POStatus, MONumber, MOStatus, CreationDate, LastUpdateDate)
VALUES (:PR_HEADER_ID,:PR_LINE_ID,:PR_NUMBER,:PR_STATUS,:PR_DESCRIPTION,
:TTID,:PR_LINE_NUMBER,:PR_LINE_STATUS,:ITEM_CODE,:ITEM_DESCRIPTION,
:ITEM_CATEGORY,:UOM_CODE,:NEED_BY_DATE,:QUANTITY,:PRICE,:LINE_VALUE,
:PROJECT_NAME,:SUPPLIER_NAME,:PO_NUMBER,:PO_STATUS,:MO_NUMBER,
:MO_STATUS,:CREATION_DATE,:LAST_UPDATE_DATE)</db:sql>
					<db:input-parameters><![CDATA[#[{
"PR_HEADER_ID" : payload.PR_HEADER_ID[0],
"PR_LINE_ID" : payload.PR_LINE_ID[0],
"PR_NUMBER"  : payload.PR_NUMBER[0],
"PR_STATUS"  : payload.PR_STATUS[0],
"PR_DESCRIPTION" : payload.PR_DESCRIPTION[0],
"TTID" : payload.TTID[0],
"PR_LINE_NUMBER" : payload.PR_LINE_NUMBER[0],
"PR_LINE_STATUS" : payload.PR_LINE_STATUS[0],
"ITEM_CODE" : payload.ITEM_CODE[0],
"ITEM_DESCRIPTION" : payload.ITEM_DESCRIPTION[0],
"ITEM_CATEGORY" : payload.ITEM_CATEGORY[0],
"UOM_CODE" : payload.UOM_CODE[0],
"NEED_BY_DATE" : payload.NEED_BY_DATE[0],
"QUANTITY" : payload.QUANTITY[0],
"PRICE" : payload.PRICE[0],
"LINE_VALUE" : payload.LINE_VALUE[0],
"PROJECT_NAME" : payload.PROJECT_NAME[0],
"SUPPLIER_NAME" : payload.SUPPLIER_NAME[0],
"PO_NUMBER" : payload.PO_NUMBER[0],
"PO_STATUS" : payload.PO_STATUS[0],
"MO_NUMBER" : payload.MO_NUMBER[0],
"MO_STATUS" : payload.MO_STATUS[0],
"CREATION_DATE" : payload.CREATION_DATE[0],
"LAST_UPDATE_DATE" : payload.LAST_UPDATE_DATE[0] 
}]]]></db:input-parameters>
				</db:insert>
				<logger level="INFO" doc:name="Log sucess PR_LINEID" doc:id="67d6baaf-0a64-43f8-841c-3e3237981485" message='#[(vars.dataFields.PR_LINEID default "") ++ " PR with LINE_ID Sucessfully Processed.!!!!!----"]' />
				<set-variable value="#[output application/java --- (vars.successList default []) + vars.dataFields.PR_LINEID]" doc:name="Set successList" doc:id="3c8f69ae-8235-4ee7-b258-b5567bb93f8a" variableName="successList" />
				<set-variable value="#[sizeOf(vars.successList)]" doc:name="Set totalRecords" doc:id="339a74e6-47b7-4ca0-a279-4c4cc4d1b4af" variableName="totalRecords" />
			<logger level="INFO" doc:name="Log Total Insert Counts" doc:id="5e004881-c4c8-48f5-a1cd-66eff9ab9a8a" message='#["----------Total Count Inserted in TT--------- " ++ (vars.totalRecords default 0)]' />
				<db:update doc:name="Update Stagging Table" doc:id="7569cbc2-4eec-41aa-a670-07304a2e2f3f" config-ref="Email_Audit_Database_Config">
				<db:sql >update atc_tt_stagging set RETRYSTATUS=:retryStatus,RETRYCOUNT=:retryCount, JOBSTATUS=:jobStatus, MODIFIEDDATE=sysdate where PRNUMBER=:prNumber and LINEID=:lineId and FLOWNAME=:flowName</db:sql>
				<db:input-parameters ><![CDATA[#[{
 "flowName" : vars.flowName,
 "retryStatus": 'Success',
 "prNumber": vars.dataFields.PR_NUMBER,
 "lineId": vars.dataFields.PR_LINE_ID,
 "retryCount" : vars.retryCounter,
 "jobStatus": 'Success'
}]]]></db:input-parameters>
			</db:update>
			<error-handler>
				<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="d26d2416-7243-429b-bbab-24e7d1647c4a" when="#[vars.retryCounter &lt; 3]" type="ANY">
					<set-variable value="#[output application/java --- (vars.failedList default[]) + vars.PR_LINEID]" doc:name="Set failedList" doc:id="09eee99b-c87f-494f-8136-28f80c32b000" variableName="failedList" />
						<logger level="INFO" doc:name="Log Failed Count" doc:id="bac8ed31-cc59-472c-b2e2-f58775bb9c5c" message='#["---------RetryFlow Total TT Failed Counts----- " ++ sizeOf(vars.failedList)]' />
						<logger level="INFO" doc:name="Log Fail PR_LINEID" doc:id="a6e28982-e545-4abf-9c9b-2c4e32e9b902" message='#[(vars.dataFields.PR_LINEID default "") ++ " ------RetryFlow Failed PR with LINE_ID-------"]' />
					<logger level="INFO" doc:name="Log Error" doc:id="500c7613-e80a-421b-b3b8-1cc8cac53d97" message="#[error.detailedDescription]" />
					<db:update doc:name="Update Status" doc:id="a1bc8f3f-6642-4023-9ead-cac1859f9cad" config-ref="Email_Audit_Database_Config">
						<db:sql >update atc_tt_stagging set RETRYCOUNT=:retryCount, JOBSTATUS=:jobStatus, MODIFIEDDATE=sysdate,RETRYSTATUS=:retryStatus,RETRYERRORMSG=:retryErrorMsg where PRNUMBER=:prNumber and LINEID=:lineId and FLOWNAME=:flowName</db:sql>
						<db:input-parameters ><![CDATA[#[{
 "flowName" : vars.flowName,
 "prNumber": vars.dataFields.PR_NUMBER,
 "lineId": vars.dataFields.PR_LINE_ID,
 "retryCount" : vars.retryCounter,
 "jobStatus":"Failed",
 "retryStatus" : "Retry-Failed",
 "retryErrorMsg": write(error.detailedDescription,'application/json')
}]]]></db:input-parameters>
					</db:update>
				</on-error-continue>
			</error-handler>
		</try>
	</flow>
</mule>
