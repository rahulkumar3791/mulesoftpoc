<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	<flow name="ebs-getLandLeaseRentData-flow" doc:id="e822bb53-61f3-4086-a7ce-6313d0710168" >
		<choice doc:name="SiteId is Null?" doc:id="d1397ed6-e71a-40e1-8ef9-ec1445f1b05d" >
			<when expression='#[(vars.siteId != null and vars.siteId != "")]'>
				<logger level="INFO" doc:name="Log Request Data" doc:id="6be3064b-6153-4efd-9387-24e8c7b5aa12" message="'[GetLandLeaseRentData][Data Requested for siteId :' ++  write(payload ,'application/java') ++ ']'"/>
				<set-variable value="#[vars.siteId]" doc:name="Set requestData" doc:id="cf76ae74-5fd0-4eff-99a6-8b562c21bcea" variableName="requestData"/>
				<db:stored-procedure doc:name="GET LAND LEASE RENT DATA" doc:id="42cd1d16-7e8d-4ce0-b216-334feace35ea" config-ref="Oracle_Configuration">
					<db:sql >{ :result = call XXATC.ATC_PN_IND_TT_UTILS_PKG.GET_LAND_RENT_HIST(:requestData) }</db:sql>
					<db:input-parameters ><![CDATA[#[{
	"requestData" : vars.requestData
}]]]></db:input-parameters>
					<db:output-parameters >
						<db:output-parameter key="result" customType="CURSOR" />
					</db:output-parameters>
				</db:stored-procedure>
				<flow-ref doc:name="data-flow" doc:id="e6775e42-b208-4b94-b6e8-d6c2ca567913" name="data-flow"/>
			</when>
			<otherwise >
				<ee:transform doc:name="Set SOAP Response" doc:id="75142bd3-d128-4716-a575-e1bb6c61fa67" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<set-variable value="#[now().milliseconds]" doc:name="Set responseTime" doc:id="11358396-e865-485f-a27f-a519c630b8d5" variableName="responseTime"/>
				<set-variable value="#[(vars.responseTime.dayOfYear-vars.requestTime.dayOfYear)*(24*60*60*1000)+(vars.responseTime.hours-vars.requestTime.hours)*(60*60*1000)+(vars.responseTime.minutes-vars.requestTime.minutes)*(60*1000)+(vars.responseTime.seconds-vars.requestTime.seconds)*(1000)+(vars.responseTime.milliSeconds-vars.requestTime.milliSeconds)]" doc:name="Total Response Time Calculation" doc:id="ac9d175c-dfbd-43b8-a788-e5f544fd4daf" variableName="totalTime"/>
				<logger level="INFO" doc:name="Log Response Time" doc:id="915a036e-23cb-4631-9ef0-2c87912c2737" message="#['[GetLandLeaseRentData][TotalTime : ' ++ vars.totalTime  ++ 'ms]']"/>
			</otherwise>
		</choice>
	</flow>
	<flow name="data-flow" doc:id="0c2dc640-3ff0-44ec-9b46-112ce66614d3" > 
	<choice doc:name="Data Found?" doc:id="ccdd52ec-6e27-40d0-b8e0-cffb7d618a4f" >
					<when expression="#[sizeOf(payload.result) &gt; 0]">
						<set-payload value="#[payload.result]" doc:name="Set Payload" doc:id="1ea3fc0f-a6ef-4186-9b42-d5635cfe4b16" />
						<set-variable value="#[sizeOf(payload)]" doc:name="Set recordCount" doc:id="e34ef664-4fe0-48e0-83b9-b76dbce2173a" variableName="recordCount"/>
				<logger level="INFO" doc:name="Log Data found" doc:id="1882c3e3-40a5-49fe-946c-f6bb8bfe0813" message='#[" Count : " ++ sizeOf(payload)]' />
				<ee:transform doc:name="Transform Message" doc:id="b94173e5-8790-498b-a0e4-e289373fb85e">
								<ee:message>
									<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map(payload,idx) -> {
              amount:payload.AMOUNT,
              currentRent:payload.CURRENT_RENT,
              details:payload.DETAILS,
              executionDate:payload.EXECUTION_DATE,
              globalSiteId:payload.GLOBAL_SITE_ID,
              header:payload.HEADER,
              principalRent:payload.PRINCIPAL_RENT
}
]]></ee:set-payload>
								</ee:message>
							</ee:transform>
				<ee:transform doc:name="Set SOAP Response With Data" doc:id="9f1861d2-6518-46e6-a28f-d5003bf77db7">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/xml  writeDeclaration=false
 
ns soap http://schemas.xmlsoap.org/soap/envelope/
ns ns2 http://land.lease.ebs.atc.com/
---
soap#Envelope @():
 {
   soap#Body :{
    ns2#getLandLeaseRentDataResponse:{
       response:{
          header:{
            statusCode:"SUCCESS",
            statusDescription:"SUCCESS"
          },
          landLeaseRentHist:{
            landLeaseRent: payload
          }
     }
    }
   }
  }]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<set-variable value="#[now().milliseconds]" doc:name="Set Response Time" doc:id="1bd84332-de91-473e-9508-e7475b3e9c84" variableName="responseTime"/>
						<set-variable value="#[payload]" doc:name="Set response" doc:id="76c0572b-e525-4c81-9d12-4d7dfe3a4b8c" variableName="response"/>
				<logger level="INFO" doc:name="Log Total Time" doc:id="2612aed7-ba73-455b-9721-2e9c0224c6fa" message="#['[GetLandLeaseRentData][ResponseTime :' ++ vars.responseTime ++ ']']"/>
						<ee:transform doc:name="Audit Payload" doc:id="0f38158a-5af8-421d-89fb-adb589b00327" >
							<ee:message >
								<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
   "service": 'Get Land Lease Rent Data',
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":'I-0102' ,
   "interface_type": "SOAP",
   "requester_ip" : vars.ip,
   "data": {
   	  "Request Data " :"SiteId : " ++ vars.requestData default "",
	  "Record Count " :vars.recordCount,
	  "Status " : "Success"
     }
}]]></ee:set-payload>
							</ee:message>
						</ee:transform>
						<flow-ref doc:name="call-audit-serviceFlow" doc:id="13c2558e-92d5-48dd-a4f8-aa70c72d625c" name="call-audit-serviceFlow"/>
					
</when>
					<otherwise >
						<logger level="INFO" doc:name="Logger" doc:id="3b3735ff-c81e-49be-90da-ca490b31666b" message="#['[GetLandLeaseRentData][No data extracted for siteId :' ++ vars.siteId ++ ' - Count : 0]']"/>
						<ee:transform doc:name="Set SOAP Reponse" doc:id="5f5e6059-c979-4dc8-b5dd-bd64a18bd6d8" >
							<ee:message >
								<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
}]]></ee:set-payload>
							</ee:message>
						</ee:transform>
						<set-variable value="#[now().milliseconds]" doc:name="Set responseTime" doc:id="562b915b-b942-4b3b-83e3-d746596297c8" variableName="responseTime"/>
						<logger level="INFO" doc:name="Log Total Time" doc:id="02e85a5d-566c-4eed-b20f-b5a42a9aaa74" message="#['[GetLandLeaseRentData][ResponseTime :'  ++ vars.responseTime ++ 'ms]']"/>
						<ee:transform doc:name="Audit Payload" doc:id="c29b1b03-71c1-4aaa-8ee7-749a801365da" >
							<ee:message >
								<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
   "service": 'Get Land Lease Rent Data',
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":'I-0102' ,
   "interface_type": "SOAP",
   "requester_ip" : vars.ip,
   "data": {
   	  "Request Data " :vars.requestData ,
	  "Total Time" : vars.totalTime,
	  "Record Count ":vars.recordCount,
	  "Status " : "SUCCESS_NO_DATA_FOUND"
     }
}]]></ee:set-payload>
							</ee:message>
						</ee:transform>
						<flow-ref doc:name="call-audit-serviceFlow" doc:id="777a5e4c-4d09-4d99-acd8-12ecb9108927" name="call-audit-serviceFlow"/>
					</otherwise>
				</choice>
	
	
	</flow>
	
	
	
	
</mule>
