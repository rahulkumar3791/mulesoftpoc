<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking"
	xmlns:mule-ss="http://www.mulesoft.org/schema/mule/spring-security"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw"
	xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:vm="http://www.mulesoft.org/schema/mule/vm"
	xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:quartz="http://www.mulesoft.org/schema/mule/quartz"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/quartz http://www.mulesoft.org/schema/mule/quartz/current/mule-quartz.xsd
http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/current/mule-vm.xsd
http://www.mulesoft.org/schema/mule/ee/dw http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/spring-security http://www.mulesoft.org/schema/mule/spring-security/current/mule-spring-security.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd">
	<flow name="project-status-ttId-main-Flow">
		<set-variable variableName="ttId"
			value="#[message.inboundProperties.'http.query.params'.TTId]"
			doc:name="ttId" />
		<set-variable variableName="interface_type" value="${interface.type}"
			doc:name="interfaceType" />
		<set-variable variableName="interfaceNumber"
			value="${interface.id.project.status.ttid}" doc:name="interfaceNumber" />
		<set-payload value="#[flowVars.ttId]" doc:name="Set Payload" />
		<choice doc:name="Choice">
			<when expression="#[payload == null || payload == &quot;&quot;]">
				<logger message="Provide a TT Id to process data" level="INFO"
					doc:name="Log Response" />
				<set-payload value="Please provide TT Id to process data"
					doc:name="Set Payload" />
			</when>
			<otherwise>
				<ee:multi-transactional action="ALWAYS_BEGIN"
					doc:name="Transactional">
					<flow-ref name="Project-Status-ttId-MainLogicFlow"
						doc:name="Project-Status-ttId-MainLogicFlow" />
				</ee:multi-transactional>
				<choice doc:name="Choice">
					<when expression="flowVars.flag == 0">
						<flow-ref name="project-status-FinalMessage-subFlow"
							doc:name="project-status-FinalMessage-subFlow" />
					</when>
					<otherwise>
						<dw:transform-message doc:name="Transform Message">
							<dw:set-payload><![CDATA[%dw 1.0
%output application/json
---
{
	message 		: "Flow has been completed with errors",
	Interface		: "Project Status from  TARANTULA to Oracle"
}]]></dw:set-payload>
						</dw:transform-message>
					</otherwise>
				</choice>
			</otherwise>
		</choice>
	</flow>
	<flow name="Project-Status-TT-to-Oracle-ttId-Http-Flow">
		<http:listener config-ref="HTTP_Listener_Configuration"
			path="/projectstatus/siteId" allowedMethods="GET" doc:name="HTTP" />
		<mule-ss:http-security-filter realm="mule-realm" />
		<set-variable variableName="flowName" value="#['Project Status']"
			doc:name="flowName" />
		<set-variable variableName="ip"
			value="#[message.inboundProperties['X-Forwarded-For']]" doc:name="Set ip" />
		<logger
			message="-------------Starting Project Status TTID Flow -----------------------"
			level="INFO" doc:name="Log Start of flow" />
		<flow-ref name="project-status-ttId-main-Flow" doc:name="project-status-ttId-main-Flow" />
		<exception-strategy ref="exceptionhandlingChoice_Exception_Strategy"
			doc:name="Reference Exception Strategy" />
	</flow>
	<flow name="Project-Status-ttId-MainLogicFlow">
		<set-variable variableName="flowName" value="#['TT_PROJ_STATUS']"
			doc:name="InterfaceName" />

		<enricher source="#[payload[0].batchNumber]" target="#[flowVars.batchID]"
			doc:name="Message Enricher">
			<flow-ref name="common-Generate-Batch-Number-subFlow"
				doc:name="common-Generate-Batch-Number-subFlow" />
		</enricher>
		<flow-ref name="Project-Status-ttId-ReadFrom-TT-subFlow"
			doc:name="Project-Status-ttId-ReadFrom-TT-subFlow" />
		<logger
			message="After Reading the Data from SQL Server: #[payload.toString()]"
			level="DEBUG" doc:name="Debug-Log Data from SQL" />
		<choice doc:name="Choice">
			<when expression="payload.size()==0">
				<logger message="No Updated Records available" level="INFO"
					doc:name="Logger" />
			</when>
			<otherwise>
				<flow-ref name="Project-Status-ttId-WriteTo-Oracle-subFlow"
					doc:name="Project-Status-ttId-WriteTo-Oracle-subFlow" />
				<flow-ref name="Project-Status-GetTotalRecordsSub_Flow"
					doc:name="Project-Status-GetTotalRecordsSub_Flow" />
				<flow-ref name="successMail_SiteIdSub_Flow" doc:name="successMail_SiteIdSub_Flow" />
				<flow-ref name="auditDataFlow" doc:name="auditDataFlow" />

			</otherwise>
		</choice>
		<set-variable variableName="flag" value="#['0']"
			doc:name="flag" />
		<exception-strategy ref="exceptionhandlingChoice_Exception_Strategy"
			doc:name="Reference Exception Strategy" />

	</flow>
	<sub-flow name="Project-Status-ttId-ReadFrom-TT-subFlow">
		<db:select config-ref="Generic_Database_Configuration"
			doc:name="SQLServer Database">
			<db:dynamic-query><![CDATA[SELECT O_ProjectStatusId,TTID, TTIDStatus, CONVERT(DATETIME2(0),date) "ttDate",CONVERT(DATETIME2(0),LastUpdatedDate) "LastUpdatedDate"
FROM O_Project_Status WHERE LastUpdatedDate is not null and TTID = '#[flowVars.ttId]']]></db:dynamic-query>

		</db:select>
		<dw:transform-message doc:name="Transform Message">
			<dw:set-payload><![CDATA[%dw 1.0
%output application/java
---
payload map ((payload01 , indexOfPayload01) -> {
		PROJECT_STATUS_ID:payload01.O_ProjectStatusId,
		TT_ID: payload01.TTID,
		TT_ID_STATUS: payload01.TTIDStatus,
		TT_DATE: payload01.ttDate,
		BATCH_NUMBER : flowVars.batchID
		})]]></dw:set-payload>
			<dw:set-variable variableName="ListOfLastUpdatedDate"><![CDATA[%dw 1.0
%output application/java
---
(payload map ((payload01 , indexOfPayload01) -> {
	date: payload01.LastUpdatedDate
}) orderBy $.date)[-1..0]]]></dw:set-variable>
		</dw:transform-message>
		<logger message="Data from Tarantula ==&gt; #[payload]" level="DEBUG"
			doc:name="Debug-Log Data from Tarantula" />

	</sub-flow>
	<sub-flow name="Project-Status-ttId-WriteTo-Oracle-subFlow">
		<choice doc:name="Choice">
			<when expression="${projectstatus.debug}==true">
				<flow-ref name="project-status-ttId_BulkLoad-DEBUG-implSub_Flow"
					doc:name="project-status-ttId_BulkLoad-DEBUG-implSub_Flow" />
			</when>
			<otherwise>
				<logger
					message="Bulk Load Debug is not enabled, please enable projectstatus.debug to true"
					level="INFO" doc:name="Logger" />
			</otherwise>
		</choice>
		<db:insert config-ref="Oracle_Configuration" bulkMode="true"
			doc:name="Oracle Database">
			<db:dynamic-query><![CDATA[INSERT INTO XXATC.ATC_PA_IND_PS_UPD_TT_STG(BATCH_NUMBER,TT_ID, TT_ID_STATUS, TT_DATE) VALUES ('#[payload.BATCH_NUMBER]', '#[payload.TT_ID]', '#[payload.TT_ID_STATUS]',TO_DATE('#[payload.TT_DATE]','yyyy-MM-dd HH24:mi:ss'))]]></db:dynamic-query>
		</db:insert>


	</sub-flow>
	<flow name="Project-Status-GetTotalRecordsSub_Flow">
		<set-variable variableName="lastUpdateDate"
			value="#[flowVars.ListOfLastUpdatedDate[0].date]" doc:name="lastUpdateDate" />
		<set-variable variableName="totalRecords"
			value="#[flowVars.ListOfLastUpdatedDate.size()]" doc:name="payloadSize" />

	</flow>
	<sub-flow name="project-status-ttId_BulkLoad-DEBUG-implSub_Flow">
		<logger
			message="If there is any issue in Inserting in BULK mode, please try inserting below Insert script as it is in the Oracle"
			level="INFO" doc:name="Log Query" />
		<foreach collection="#[payload]" doc:name="For Each">
			<logger
				message="INSERT INTO XXATC.ATC_PA_IND_PS_UPD_TT_STG(BATCH_NUMBER,TT_ID, TT_ID_STATUS, TT_DATE) VALUES ('#[payload.BATCH_NUMBER]', '#[payload.TT_ID]', '#[payload.TT_ID_STATUS]',TO_DATE('#[payload.TT_DATE]','yyyy-MM-dd HH24:mi:ss'))"
				level="DEBUG" doc:name="Debug-Query Logger" />
		</foreach>
	</sub-flow>
</mule>
