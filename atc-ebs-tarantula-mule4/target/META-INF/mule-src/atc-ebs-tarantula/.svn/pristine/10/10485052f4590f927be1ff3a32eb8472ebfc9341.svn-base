<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http" 
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:sftp="http://www.mulesoft.org/schema/mule/sftp" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/sftp http://www.mulesoft.org/schema/mule/sftp/current/mule-sftp.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">
	<flow name="purchase-requisition-mainFlow" doc:id="9d06f52c-f47a-49e1-88e7-891240285a6c" >
		<logger level="INFO" doc:name="Logger" doc:id="a288bbef-3cce-4fae-836e-828dffe73a7f" message="###purchase-requistion flow is started ####"/>
		<ee:transform doc:name="variable Initialize" doc:id="a746042c-e43e-4698-a4c0-af66a74bb8a0" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="ip" ><![CDATA[server.ip as String default "0.0.0.0"]]></ee:set-variable>
				<ee:set-variable variableName="flowName" ><![CDATA["TT_PR_DETAILS"]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Purchase-Requistion-MainLogicFlow" doc:id="cefd35dd-cdab-4b06-8dbf-4293c9ff70a4" name="Purchase-Requistion-MainLogicFlow" />
		<logger level="INFO" doc:name="Logger" doc:id="ecad3338-67dd-44ca-ab91-27513062b8c1" message="###purchase-requistion flow is Completed ####"/>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="0face82f-7db4-4bce-9995-ebb6debec773" type="ANY">
				<set-variable value="#[error.detailedDescription]" doc:name="Set errorMsg" doc:id="4894fdb5-e62b-4e07-bd8d-2f2f3366506b" variableName="errorMsg"/>
				<logger level="INFO" doc:name="Error Log" doc:id="67e2b8df-8342-4479-bea9-8119b53738d6" message="#[vars.errorMsg]"/>
				<set-variable value='#["Failed"]' doc:name="Set Status" doc:id="6ba6d45d-fa1a-4b3a-afc1-099b85826a2e" variableName="status"/>
				<ee:transform doc:name="Email-Audit Payload" doc:id="0b10f922-f7a0-4a4b-8d46-45501cc1b4a0" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
   
   "service": p('current.project.name'),
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":p('interface.id.purchase.requisition') ,
   "interface_type": p('current.project.type'),
   "requester_ip" : vars.ip,
   "data": {
   	      "status": vars.status,
   	      "flowName": "Purchase requisition : Oracle to TARANTULA",
          "error" : vars.errorMsg
         }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="send-email-audit-Flow" doc:id="13755d4f-015f-447c-aa19-9211f8df9607" name="send-email-audit-Flow"/>
			</on-error-propagate>
		</error-handler>
	</flow>
	<flow name="Purchase-Requistion-MainLogicFlow" doc:id="f8dd7cf8-9793-4052-9e9e-7a055df42f1e" >
		<flow-ref doc:name="ControlFlow-Read-LastRunDateFlow" doc:id="a94fda96-5659-4f46-a02d-fb027445707b" name="ControlFlow-Read-LastRunDateFlow"/>
		<db:select doc:name="Read MAX_LAST_UPDATE_DATE from Oracle" doc:id="3dd23ad7-c8f0-4ffb-bddc-5c2754289dc6" config-ref="Oracle_Configuration">
			<db:sql>SELECT    to_char(max(LAST_UPDATE_DATE),'yyyy-mm-dd HH24:MI:SS') AS MAX_LAST_UPDATE_DATE FROM XXATC.ATC_PO_IND_SVCS_PR_TT_V</db:sql>
		</db:select>
		<set-variable value="#[payload[0].MAX_LAST_UPDATE_DATE]" doc:name="Set MAX_LAST_UPDATE_DATE" doc:id="cebbb635-b3ff-46ba-9945-80b23b5844de" variableName="MAX_LAST_UPDATE_DATE" />
		<logger level="INFO" doc:name="Log MAX_LAST_UPDATE_DATE" doc:id="a1ca7920-f518-4aa3-acf2-65cb072b09cb" message='#["MAX_LAST_UPDATE_DATE  IS ::: " ++ vars.MAX_LAST_UPDATE_DATE]'/>
		<logger level="INFO" doc:name="Log Reading Data from Oracle" doc:id="c511e5ae-539a-4147-befc-b93e20a6a23d" message="-------------------Reading Purchase Requisition Record Count from Oracle----------------"/>
		<db:select doc:name="Data Count from Oracle" doc:id="3b91bed5-706f-4d96-814e-db17b01f0c24" config-ref="Oracle_Configuration">
			<db:sql>SELECT COUNT(*) AS COUNT FROM XXATC.ATC_PO_IND_SVCS_PR_TT_V
WHERE LAST_UPDATE_DATE between  to_date(:lastRunDate,'DD-MM-YYYY HH24:MI:SS') and  to_date(:maxLastUpdateDate,'DD-MM-YYYY HH24:MI:SS')</db:sql>
			<db:input-parameters><![CDATA[#[{
	"lastRunDate" : vars.lastRunDate,
	"maxLastUpdateDate" : vars.MAX_LAST_UPDATE_DATE as LocalDateTime {format:"yyyy-MM-dd HH:mm:ss"} as String {format:"dd-MMM-yyyy HH:mm:ss"}
}]]]></db:input-parameters>
		</db:select>
		<set-variable value="#[payload[0].COUNT]" doc:name="Set recordCount" doc:id="31149285-a3d9-43ed-a58a-ea3132420ec0" variableName="recordCount"/>
		<logger level="INFO" doc:name="Log Records Count" doc:id="b7885e88-0e71-49ed-893a-5c9e66fe2fff" message='#["-----Number of Purchase Requisition Records Count----- " ++ vars.recordCount]'/>
		<choice doc:name="Choice" doc:id="910b98d0-178f-47d3-ae0d-c2fbe6120492" >
			<when expression="#[sizeOf(vars.recordCount) &gt; 0]">
				<flow-ref doc:name="Purachese-Requisition-ReadFromOracle-subFlow" doc:id="2371fe09-0bd9-4a76-a900-44ca421caa87" name="Purachese-Requisition-ReadFromOracle-subFlow"/>
				<flow-ref doc:name="Purchase-Requisition-Get-maxLastRunDateSub_Flow" doc:id="bcd060ff-1d58-4148-9cf9-7dbcd250eddf" name="Purchase-Requisition-Get-maxLastRunDateSub_Flow"/>
				<flow-ref doc:name="Purchase-Requisition-ControlTable-Update-subFlow" doc:id="73442ce4-522b-4e3d-9caf-72187a96346c" name="ControlTable-Update-subFlow"/>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Log No updated records" doc:id="e95c7874-f363-4b1d-8050-7a70d9c1f4a7" message="No Updated Records available"/>
			</otherwise>
		</choice>
		<choice doc:name="Choice" doc:id="1f2bdf68-ddf7-4b63-9191-df591acf219f" >
			<when expression="#[(vars.totalRecords != 0) or (sizeOf(vars.failedList) !=0)]">
				<set-variable value='#["success"]' doc:name="Set Status" doc:id="d2c62da9-277f-4cd2-85d3-02ff528d3af9" variableName="status" />
				<ee:transform doc:name="Email Audit Payload" doc:id="90f839bb-ee0e-4691-844e-6aa60e2b7f44">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
   
   "service": p('current.project.name'),
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":p('interface.id.purchase.requisition') ,
   "interface_type": p('current.project.type'),
   "requester_ip" : vars.ip,
   "data": {
   	      "status": vars.status,
   	       "flowName": "Purchase requisition : Oracle to TARANTULA",
          "recordsProcessed" : vars.totalRecords,
          "currentLastRunDate" : vars.lastUpdateDate,
          "batchNumber": vars.batchDetails.batchNumber,
          "successList" : vars.successList default [],
          "failedList" : vars.failedList default []
         }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="send-email-audit-Flow" doc:id="5b5a53c4-62a3-48b8-a1ff-c67f395f6ab2" name="send-email-audit-Flow" />
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Logger" doc:id="278ccc2f-c765-410a-ad61-328d756faf87" message="############## No record inserted in TT DB #############"/>
			</otherwise>
		</choice>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="16d33741-9c41-4317-adba-e9235d7aaaaf" >
				<logger level="INFO" doc:name="Logger" doc:id="bf0c9575-fa17-4880-af15-0f2972e93706" message="#[error.detailedDescription]"/>
			</on-error-propagate>
		</error-handler>
	</flow>
	<flow name="Purachese-Requisition-ReadFromOracle-subFlow" doc:id="56f0a171-8f27-49de-b6c3-403cfba0cf8f" >
		<ee:transform doc:name="Init Variables" doc:id="2e3afae5-7102-4038-9ace-4d90b80e37cd" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="totalRecords" ><![CDATA[0]]></ee:set-variable>
				<ee:set-variable variableName="batchSize" ><![CDATA[p('purchase.requisition.batch_size')]]></ee:set-variable>
				<ee:set-variable variableName="offset" ><![CDATA[0]]></ee:set-variable>
				<ee:set-variable variableName="listVar" ><![CDATA[[]]]></ee:set-variable>
				<ee:set-variable variableName="successList" ><![CDATA[[]]]></ee:set-variable>
				<ee:set-variable variableName="failedList" ><![CDATA[[]]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="509381f0-e7d4-4746-819f-902cdd4dcbb7" message=" ----------------DataSync from Oracle to TT Purchase Requisition----------------------"/>
		<ee:transform doc:name="Transform Message" doc:id="ecb8c28f-9f7f-45f8-aeee-dd6064c092b4" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java

var loopcount = vars.recordCount as Number
var batch_size = vars.batchSize as Number
var dummy = vars.listVar
fun prepareList(dummy , maxSize: Number) = 
 if(sizeOf(dummy) >= maxSize ) 
   dummy 
 else 
    prepareList(dummy ++ [(sizeOf(dummy) + 1) as Number],maxSize)
---
if( loopcount < batch_size and loopcount != 0) 
dummy+ 1 default ""
else
prepareList([],ceil(loopcount/batch_size))

]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<foreach doc:name="For Each" doc:id="4ae4404b-f65b-46cb-9565-0247b721f888">
			<logger level="INFO" doc:name="Logger" doc:id="c6096d69-ea3e-4f76-94bc-72610a2d6ec9" message='#["Reading Paginated Purchase Requisition Data  Offset--&gt; " ++ vars.offset]' />
			<try doc:name="Try" doc:id="56fffe48-055c-44cf-89e4-62b5626df1cf" >
				<db:select doc:name="Read Data from Oracle" doc:id="b9641965-6ef7-4b20-aca3-5cafa641d521" config-ref="Oracle_Configuration">
				<db:sql>SELECT
    PR.PR_HEADER_ID, 
    PR.PR_NUMBER,
    PR.PR_STATUS, 
    PR.PR_DESCRIPTION,TTID, 
    PR.PR_LINE_ID,
    PR.PR_LINE_NUMBER,
    PR.PR_LINE_STATUS,
    PR.ITEM_CODE, 
    PR.ITEM_DESCRIPTION, 
    DECODE(PR.ITEM_CATEGORY, 'Airconditioner' , DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'Battery Bank', 
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'DG',
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'Shelter' , 
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'SMPS' , 
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'TOWER' , 
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    PR.ITEM_CATEGORY) &quot;ITEM_CATEGORY&quot;,
    PR.UOM_CODE, 
    to_char(PR.NEED_BY_DATE,'yyyy-mm-dd HH24:MI:SS') &quot;NEED_BY_DATE&quot;,
    PR.QUANTITY,
    PRICE, 
    PR.LINE_VALUE ,
    PR.PROJECT_NAME,
    PR.SUPPLIER_NAME,
    to_char(PR.CREATION_DATE,'yyyy-mm-dd HH24:MI:SS') &quot;CREATION_DATE&quot;,
    to_char(PR.LAST_UPDATE_DATE,'yyyy-mm-dd HH24:MI:SS') &quot;LAST_UPDATE_DATE&quot;,
    PR.PO_NUMBER,
    PR.PO_STATUS,
    PR.MO_NUMBER, 
    PR.MO_STATUS
    FROM XXATC.ATC_PO_IND_SVCS_PR_TT_V PR 
    LEFT JOIN XXATC.ATC_IND_ITEM_CODE_LOOKUP LK
    ON PR.ITEM_CODE = LK.ITEM_CODE
	WHERE PR.LAST_UPDATE_DATE   between  to_date(:lastRunDate,'DD-MM-YYYY HH24:MI:SS') and  to_date(:maxLastUpdateDate,'DD-MM-YYYY HH24:MI:SS')
    ORDER BY PR.LAST_UPDATE_DATE
    OFFSET :offset ROWS FETCH NEXT :batchSize ROWS ONLY</db:sql>
				<db:input-parameters><![CDATA[#[{
  "lastRunDate" : vars.lastRunDate,
  "batchSize" : vars.batchSize,
  "offset" : vars.offset,
  "maxLastUpdateDate": vars.MAX_LAST_UPDATE_DATE as LocalDateTime {format:"yyyy-MM-dd HH:mm:ss"} as String {format:"dd-MMM-yyyy HH:mm:ss"}
}]]]></db:input-parameters>
			</db:select>
				<logger level="INFO" doc:name="Logger" doc:id="b934b643-0371-42ad-bb2c-bd1341282702" message='#[" ###### Success Batch Number ############ " ++ vars.counter]'/>
				<error-handler >
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="34fa4ecd-3e52-41c1-bd6a-e06831d4dade" >
						<logger level="INFO" doc:name="Logger" doc:id="7c821bed-7709-42e9-85a4-3ce89db22cef" message='#[" ###### Failed Batch Number ############" ++ vars.counter]'/>
						<logger level="INFO" doc:name="Logger" doc:id="151f538a-ac97-4a68-9130-2b4b6e920a7d" message="#[error.detailedDescription]"/>
					</on-error-continue>
				</error-handler>
			</try>
			<ee:transform doc:name="Transform Message" doc:id="53566978-601d-4309-9a6b-8ca8fe9aa398">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
payload map (payload01 , indexOfPayload01) -> {
		PR_HEADER_ID		:	payload01.PR_HEADER_ID,
		PR_NUMBER			: 	payload01.PR_NUMBER,
		PR_STATUS  			:	payload01.PR_STATUS,
		PR_DESCRIPTION  	:	payload01.PR_DESCRIPTION,
		TTID       			:  payload01.TTID,
		PR_LINE_ID 			:	payload01.PR_LINE_ID,
		PR_LINE_NUMBER   	:	payload01.PR_LINE_NUMBER,
		PR_LINE_STATUS   	:	payload01.PR_LINE_STATUS,
		ITEM_CODE  			:	payload01.ITEM_CODE,
		ITEM_DESCRIPTION 	:	payload01.ITEM_DESCRIPTION,
		ITEM_CATEGORY    	:	payload01.ITEM_CATEGORY,
		UOM_CODE   			:	payload01.UOM_CODE,
		NEED_BY_DATE     	:	payload01.NEED_BY_DATE,
		QUANTITY   			:	payload01.QUANTITY,
		PRICE      			:	payload01.PRICE,
		LINE_VALUE 			:	payload01.LINE_VALUE,
		PROJECT_NAME		: 	payload01.PROJECT_NAME,
		SUPPLIER_NAME    	:	payload01.SUPPLIER_NAME,
		CREATION_DATE    	:	payload01.CREATION_DATE ,
		LAST_UPDATE_DATE 	:	payload01.LAST_UPDATE_DATE,
		PO_NUMBER  			:	payload01.PO_NUMBER,
		PO_STATUS  			:	payload01.PO_STATUS,
		MO_NUMBER  			:	payload01.MO_NUMBER,
		MO_STATUS  			:	payload01.MO_STATUS
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>
			<logger level="INFO" doc:name="Log PR Numbers" doc:id="d7d58cd1-6047-4447-bce8-9af04f2b4885" message="#[output application/json --- payload.PR_NUMBER]" />
			<flow-ref doc:name="Purachese-Requisition-write-to-TT-subFlow" doc:id="09e351d9-6f86-42df-a82a-6eaa0e545c04" name="Purachese-Requisition-write-to-TT-subFlow" />
			<set-variable value="#[vars.counter * vars.batchSize]" doc:name="Set offset" doc:id="608cc60f-c2dc-4fde-b5f5-0773b439602c" variableName="offset" />
		</foreach>
		<remove-variable doc:name="Remove offset" doc:id="5719fe0a-9c8f-44a1-a3e9-a4d740bb8140" variableName="offset"/>
	</flow>
	<flow name="Purchase-Requisition-Get-maxLastRunDateSub_Flow" doc:id="cd81cf60-5967-4dfb-a00d-0512f7ec5f6c" >
		<logger level="INFO" doc:name="Log reading LastRunDate" doc:id="7cdb2c4a-9d1e-4735-b265-2407272d9e5a" message="---------------------Reading max LastRunDate-------------------------"/>
		<set-variable value='#[vars.MAX_LAST_UPDATE_DATE as LocalDateTime {format: "yyyy-MM-dd HH:mm:ss"} as String {format: "dd-MM-yyyy HH:mm:ss"}]' doc:name="Set lastUpdateDate" doc:id="70a37056-d181-4523-89d7-613a1621db15" variableName="lastUpdateDate"/>
		<logger level="INFO" doc:name="Log maxLastUpdatedDate" doc:id="9a5c9b6f-de13-4fd4-acc9-c3dbbb71789b" message='#["maxLastUpdatedDate from TT==&gt;" ++ vars.lastUpdateDate]'/>
	</flow>
	<flow name="Purachese-Requisition-write-to-TT-subFlow" doc:id="f01f968a-72bf-4998-a521-70fafdc0546c" >
		<logger level="INFO" doc:name="Logger" doc:id="89e5db72-4db8-49dd-b188-66618a9c87cb" message='#["Writing Paginated Purchase Requisition data to TT Offset--&gt; " ++ vars.offset]'/>
		<foreach doc:name="For Each" doc:id="cb2179ef-3257-46f0-b92f-0e268b23bbcc" >
			<try doc:name="Try" doc:id="5d015817-e030-4c3f-8a0e-6249582d357b" transactionalAction="ALWAYS_BEGIN">
				<ee:transform doc:name="Set dataFields" doc:id="0c5fac03-29b0-444b-b094-28868548fd07" >
					<ee:message >
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="dataFields" ><![CDATA[%dw 2.0
output application/java
---
{
	"PR_NUMBER" : payload.PR_NUMBER,
	"PR_LINE_ID" : payload.PR_LINE_ID,
	//"LastRunDate": vars.lastRunDate as LocalDateTime{format: "dd-MMM-yyyy HH:mm:ss"}as String{format:"MM-dd-yyyy HH:mm:ss"} ,
	"LastRunDate": vars.lastRunDate,
	"lastUpdateDate" : payload.LAST_UPDATE_DATE
	
}]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<set-variable value='#[(vars.dataFields.PR_NUMBER) ++ " - " ++ (vars.dataFields.PR_LINE_ID)]' doc:name="Set PR_LINEID" doc:id="25af329c-bf71-4f30-9cc4-fe42030d3086" variableName="PR_LINEID"/>
				<db:insert doc:name="Insert TT DB" doc:id="8702b815-c31c-4cc5-9e63-5fce11bac33d" config-ref="SQL_Server_Database_Config">
					<db:sql >INSERT INTO 
I_PR_PO(BOQId, PRLineId, PRNumber, PRStatus, PRDescription, TTID, PRLineNumber, PRLineStatus, ItemCode, ItemDescription, ItemName, UOMCode, NeedByDate, Quantity, Price, LineValue, ProjectName, Vendor, PONumber, POStatus, MONumber, MOStatus, CreationDate, LastUpdateDate)
VALUES (:PR_HEADER_ID,:PR_LINE_ID,:PR_NUMBER,:PR_STATUS,:PR_DESCRIPTION,
:TTID,:PR_LINE_NUMBER,:PR_LINE_STATUS,:ITEM_CODE,:ITEM_DESCRIPTION,
:ITEM_CATEGORY,:UOM_CODE,:NEED_BY_DATE,:QUANTITY,:PRICE,:LINE_VALUE,
:PROJECT_NAME,:SUPPLIER_NAME,:PO_NUMBER,:PO_STATUS,:MO_NUMBER,
:MO_STATUS,:CREATION_DATE,:LAST_UPDATE_DATE)</db:sql>
					<db:input-parameters ><![CDATA[#[{
"PR_HEADER_ID" : payload.PR_HEADER_ID,
"PR_LINE_ID" : payload.PR_LINE_ID,
"PR_NUMBER"  : payload.PR_NUMBER,
"PR_STATUS"  : payload.PR_STATUS,
"PR_DESCRIPTION" : payload.PR_DESCRIPTION,
"TTID" : payload.TTID,
"PR_LINE_NUMBER" : payload.PR_LINE_NUMBER,
"PR_LINE_STATUS" : payload.PR_LINE_STATUS,
"ITEM_CODE" : payload.ITEM_CODE,
"ITEM_DESCRIPTION" : payload.ITEM_DESCRIPTION,
"ITEM_CATEGORY" : payload.ITEM_CATEGORY,
"UOM_CODE" : payload.UOM_CODE,
"NEED_BY_DATE" : payload.NEED_BY_DATE,
"QUANTITY" : payload.QUANTITY,
"PRICE" : payload.PRICE,
"LINE_VALUE" : payload.LINE_VALUE,
"PROJECT_NAME" : payload.PROJECT_NAME,
"SUPPLIER_NAME" : payload.SUPPLIER_NAME,
"PO_NUMBER" : payload.PO_NUMBER,
"PO_STATUS" : payload.PO_STATUS,
"MO_NUMBER" : payload.MO_NUMBER,
"MO_STATUS" : payload.MO_STATUS,
"CREATION_DATE" : payload.CREATION_DATE,
"LAST_UPDATE_DATE" : payload.LAST_UPDATE_DATE 
}]]]></db:input-parameters>
				</db:insert>
				<logger level="INFO" doc:name="Log sucess PR_LINEID" doc:id="67d6baaf-0a64-43f8-841c-3e3237981485" message='#[(vars.PR_LINEID default "") ++ " PR with LINE_ID Sucessfully Processed.!!!!!----"]'/>
				<set-variable value='#[output application/java --- (vars.successList default []) + vars.PR_LINEID]' doc:name="Set successList" doc:id="3c8f69ae-8235-4ee7-b258-b5567bb93f8a" variableName="successList"/>
				<set-variable value="#[sizeOf(vars.successList)]" doc:name="Set totalRecords" doc:id="339a74e6-47b7-4ca0-a279-4c4cc4d1b4af" variableName="totalRecords" />
			<logger level="INFO" doc:name="Log Total Insert Counts" doc:id="5e004881-c4c8-48f5-a1cd-66eff9ab9a8a" message='#["----------Total Count Inserted in TT--------- " ++ (vars.totalRecords default 0)]'/>
				<error-handler>
				<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="d26d2416-7243-429b-bbab-24e7d1647c4a">
					<set-variable value='#[output application/java --- (vars.failedList default []) + vars.PR_LINEID]' doc:name="Set failedList" doc:id="09eee99b-c87f-494f-8136-28f80c32b000" variableName="failedList"/>
						<logger level="INFO" doc:name="Log Failed Count" doc:id="bac8ed31-cc59-472c-b2e2-f58775bb9c5c" message='#["---------Total TT Failed Counts----- " ++ sizeOf(vars.failedList)]'/>
						<logger level="INFO" doc:name="Log Fail PR_LINEID" doc:id="a6e28982-e545-4abf-9c9b-2c4e32e9b902" message='#[(vars.PR_LINEID default "") ++ " ------Failed PR with LINE_ID-------"]' />
					<logger level="INFO" doc:name="Log Error" doc:id="500c7613-e80a-421b-b3b8-1cc8cac53d97" message="#[error.detailedDescription]" />
						<db:insert doc:name="Insert TT Stagging tbl" doc:id="904d9979-f3fa-4c6a-b048-cda1a1c7feed" config-ref="Email_Audit_Database_Config">
							<db:sql >insert into atc_tt_stagging(flowName,eventType,batchStartDate,batchEndDate, LastRunDate,createdDate,jobStatus, errorMessage, retryCount,prNumber,lineId) values(:flowName,:eventType,:batchStartDate,:batchEndDate, TO_DATE(:LastRunDate,'DD-MM-YYYY HH24:MI:SS'),sysdate,:jobStatus, :errorMessage, :retryCount,:PRNumber,:lineId)</db:sql>
							<db:input-parameters ><![CDATA[#[{
	"flowName": vars.flowName,
	"eventType": "Oracle-TT",
	"batchStartDate": null,
	"batchEndDate": null,
	"LastRunDate": vars.dataFields.LastRunDate,
	"createdDate": now() as String{format:"MM-dd-yyyy HH:mm:ss"},
	"jobStatus": "Failed",
	"errorMessage":write(error.detailedDescription,'application/json'),
	"retryCount": 0,
	"PRNumber": vars.dataFields.PR_NUMBER,
	"lineId": vars.dataFields.PR_LINE_ID
}]]]></db:input-parameters>
						</db:insert>
						<logger level="INFO" doc:name="Logger" doc:id="a29f0070-a7d8-417b-816a-4725143798c1" message="########Failed Record inserted to TT Stagging Table#######"/>
				</on-error-continue>
			</error-handler>
		</try>
		</foreach>
	</flow>
</mule>
