<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" 
	xmlns:sftp="http://www.mulesoft.org/schema/mule/sftp"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/sftp http://www.mulesoft.org/schema/mule/sftp/current/mule-sftp.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	<flow name="project-status-tt-to-oracle-ttid-mailFlow" doc:id="9d06f52c-f47a-49e1-88e7-891240285a6c" >
		<logger level="INFO" doc:name="Logger" doc:id="a288bbef-3cce-4fae-836e-828dffe73a7f" message="######## Project-status-tt-to-oracle-ttid flow is started ########"/>
		<ee:transform doc:name="variable Initialize" doc:id="a746042c-e43e-4698-a4c0-af66a74bb8a0" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="ip" ><![CDATA[server.ip as String default "0.0.0.0"]]></ee:set-variable>
				<ee:set-variable variableName="flowName" ><![CDATA["TT_PROJ_STATUS"]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="project-Status-ttid-MainLogicFlow" doc:id="cefd35dd-cdab-4b06-8dbf-4293c9ff70a4" name="project-Status-ttid-MainLogicFlow" />
		<logger level="INFO" doc:name="Logger" doc:id="ecad3338-67dd-44ca-ab91-27513062b8c1" message="########### Project-status-tt-to-oracle-ttid  flow is Completed ###########"/>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="0face82f-7db4-4bce-9995-ebb6debec773" type="ANY">
				<set-variable value="#[error.detailedDescription]" doc:name="Set errorMsg" doc:id="4894fdb5-e62b-4e07-bd8d-2f2f3366506b" variableName="errorMsg"/>
				<logger level="INFO" doc:name="Error Log" doc:id="67e2b8df-8342-4479-bea9-8119b53738d6" message="#[vars.errorMsg]"/>
				<set-variable value='#["Failed"]' doc:name="Set Status" doc:id="6ba6d45d-fa1a-4b3a-afc1-099b85826a2e" variableName="status"/>
				<ee:transform doc:name="Email-Audit Payload" doc:id="0b10f922-f7a0-4a4b-8d46-45501cc1b4a0" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
   
   "service": p('current.project.name'),
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":p('interface.id.project.status.ttid') ,
   "interface_type": p('current.project.type'),
   "requester_ip" : vars.ip,
   "data": {
   	      "status": vars.status,
   	      "flowName": "Project Status TARANTULA to Oracle TTId",
          "error" : vars.errorMsg
         }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="send-email-audit-Flow" doc:id="13755d4f-015f-447c-aa19-9211f8df9607" name="send-email-audit-Flow"/>
			</on-error-propagate>
		</error-handler>
	</flow>
	<flow name="project-Status-ttid-MainLogicFlow" doc:id="f8dd7cf8-9793-4052-9e9e-7a055df42f1e" >
		<set-variable value="#[attributes.queryParams.TTId]" doc:name="Set TTId" doc:id="733ef648-47d5-4ee5-9334-cf34608a5351" variableName="ttid"/>
		<set-payload value="#[vars.ttid]" doc:name="Set Payload" doc:id="422e5aa4-7cc8-46c5-a04c-318866fb382e" />
		<choice doc:name="Choice" doc:id="fc5616a6-f4e8-4a2e-895e-b7ac9778fad5" >
			<when expression="#[payload =='null' and payload =='']">
				<logger level="INFO" doc:name="Logger" doc:id="fde81de6-58c0-422f-b915-8b0d5bd7548d" message="No Updated Records available"/>
			</when>
			<otherwise >
				<flow-ref doc:name="common-Generate-Batch-Number-subFlow" doc:id="208b949d-db6c-4848-a317-7b426dd09b64" name="common-Generate-Batch-Number-subFlow" target="batchDetails" />
				<flow-ref doc:name="Project-Status-ReadFrom-TT-ttid-subFlow" doc:id="579f65c0-df38-4a0b-a4d4-0543ef4e6d3a" name="Project-Status-ReadFrom-TT-ttid-subFlow" />
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="Log TT data" doc:id="b7885e88-0e71-49ed-893a-5c9e66fe2fff" message="#[&quot;After Reading the Data from SQL Server: &quot; ++ write(payload,'application/json')]"/>
		<choice doc:name="Choice" doc:id="910b98d0-178f-47d3-ae0d-c2fbe6120492" >
			<when expression="#[sizeOf(payload)&gt;0]">
				<flow-ref doc:name="Project-Status-WriteTo-Oracle-ttidsubFlow" doc:id="2371fe09-0bd9-4a76-a900-44ca421caa87" name="Project-Status-WriteTo-Oracle-ttid-subFlow"/>
				<flow-ref doc:name="Project-Status-Get-maxLastRunDateSub-ttid_Flow" doc:id="bcd060ff-1d58-4148-9cf9-7dbcd250eddf" name="Project-Status-Get-maxLastRunDateSub-ttid_Flow"/>
				<set-variable value='#["success"]' doc:name="Set Status" doc:id="d2c62da9-277f-4cd2-85d3-02ff528d3af9" variableName="status" />
				<ee:transform doc:name="Email Audit Payload" doc:id="90f839bb-ee0e-4691-844e-6aa60e2b7f44">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
   
   "service": p('current.project.name'),
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":p('interface.id.project.status.ttid') ,
   "interface_type": p('current.project.type'),
   "requester_ip" : vars.ip,
   "data": {
   	      "status": vars.status,
   	      "flowName": "Project Status TARANTULA to Oracle TTId",
          "recordsProcessed" : vars.totalRecords,
          "currentLastRunDate" : vars.lastUpdateDate,
          "batchNumber": vars.batchDetails.batchNumber[0]
         }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="send-email-audit-Flow" doc:id="5b5a53c4-62a3-48b8-a1ff-c67f395f6ab2" name="send-email-audit-Flow"/>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Log No updated records" doc:id="e95c7874-f363-4b1d-8050-7a70d9c1f4a7" message="No Updated Records available"/>
			</otherwise>
		</choice>
	</flow>
	<flow name="Project-Status-ReadFrom-TT-ttid-subFlow" doc:id="56f0a171-8f27-49de-b6c3-403cfba0cf8f" >
		<logger level="INFO" doc:name="Logger" doc:id="509381f0-e7d4-4746-819f-902cdd4dcbb7" message="Reading data from TT"/>
		<db:select doc:name="Select SQL Server Database" doc:id="b3475ec8-d4a7-44b4-823d-3e92fbcd8112" config-ref="SQL_Server_Database_Config">
			<db:sql >SELECT O_ProjectStatusId,TTID, TTIDStatus, CONVERT(DATETIME2(0),date) &quot;ttDate&quot;,CONVERT(DATETIME2(0),LastUpdatedDate) &quot;LastUpdatedDate&quot;
FROM O_Project_Status WHERE LastUpdatedDate is not null and TTID = :ttId</db:sql>
			<db:input-parameters ><![CDATA[#[{
	"ttId" : vars.ttid,
}]]]></db:input-parameters>
		</db:select>
		<ee:transform doc:name="Transform Message" doc:id="9ecdab31-4180-42ad-997f-19d12b71815a" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
payload map ((payload01 , indexOfPayload01) -> {
	    PROJECT_STATUS_ID:payload01.O_ProjectStatusId,
		TT_ID: payload01.TTID,
		TT_ID_STATUS: payload01.TTIDStatus,
		TT_DATE: payload01.ttDate  ,
		BATCH_NUMBER : vars.batchDetails.batchNumber[0]
		})]]></ee:set-payload>
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="ListOfLastUpdatedDate" ><![CDATA[%dw 2.0
output application/java
---
(payload map ((payload01 , indexOfPayload01) -> {
	date: payload01.LastUpdatedDate
}) orderBy $.date)]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
	</flow>
	<flow name="Project-Status-WriteTo-Oracle-ttid-subFlow" doc:id="9223fd98-727b-4c3a-bc61-f77c912f609a" >
		<logger level="INFO" doc:name="Log Writing data to Oracle" doc:id="97499efe-2935-40d8-86cb-cf4c35ed50d1" message="--------------------Project status TT to Oracle TTId---------Writing Data to Oracle-----------------------------"/>
		<set-variable value="#[[]]" doc:name="initialize recordlist" doc:id="3e6196f4-6d77-4017-8887-4b90a26ebdfe" variableName="recordlist"/>
		<choice doc:name="Choice" doc:id="ba50675a-5ed0-4b2f-9cd7-2ea566a1b928" >
			<when expression="#[p('project.status.debug')]">
				<logger level="INFO" doc:name="Log Insert script" doc:id="14ef26e8-ce22-4bab-abe1-34501f6eb39d" message="If there is any issue in Inserting in BULK mode, please try inserting below Insert script as it is in the Oracle"/>
				<foreach doc:name="For Each" doc:id="4659b756-f046-4b02-8196-7989a67d5f81">
					<logger level="INFO" doc:name="Query Logger" doc:id="bf19751d-5522-4c5f-bb1a-c0a03eb27bb3" message="INSERT INTO XXATC.ATC_PA_IND_PS_UPD_TT_STG(BATCH_NUMBER,TT_ID, TT_ID_STATUS, TT_DATE) VALUES ('#[payload.BATCH_NUMBER]', '#[payload.TT_ID]', '#[payload.TT_ID_STATUS]',TO_DATE('#[payload.TT_DATE]','yyyy-MM-dd HH24:mi:ss'))" />
				</foreach>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Log Debug disabled" doc:id="7ca1af80-8132-48d7-a093-362c81273a8c" message="Bulk Load Debug is not enabled, please enable projectstatus.debug to true"/>
			</otherwise>
		</choice>
		
		
		<foreach doc:name="For Each" doc:id="6494fb03-9d97-444f-a5a5-79db29b3e3f8" collection="#[payload]">
			<set-variable value='#[output application/java --- (vars.recordlist default []) + ({"BATCH_NUMBER" : payload.BATCH_NUMBER,"TT_ID" : payload.TT_ID,"TT_ID_STATUS": payload.TT_ID_STATUS,"TT_DATE": payload.TT_DATE})]' doc:name="Add data in list" doc:id="40a8c6ae-7e53-4a24-93d9-b05047f5de9a" variableName="recordlist"/>
		</foreach>
		<logger level="INFO" doc:name="Logger" doc:id="882849c0-3482-4e69-a01e-68577a6eed02" message="####### Project status TT to Oracle Bulk Insert #######"/>
		<set-payload value="#[%dw 2.0
import * from dw::core::Arrays
output application/java
---
vars.recordlist default [] divideBy p('project.status.tt.to.oracle.bulk.insert.batch.size')]" doc:name="Set Payload" doc:id="1a5438fe-49c3-4d3e-a102-5b4fa7fb0365" />
        <foreach doc:name="For Each" doc:id="3061e2cd-8156-49ec-903f-53f955e9ddf2" >
			<try doc:name="Try" doc:id="b4140523-938a-41c9-a811-38f7ddef9f5f" transactionalAction="BEGIN_OR_JOIN">
				<db:bulk-insert doc:name="Bulk insert" doc:id="a646453a-5fee-43c8-8e65-1e895f9395f2" config-ref="Oracle_Configuration">
			<db:sql>INSERT INTO XXATC.ATC_PA_IND_PS_UPD_TT_STG(BATCH_NUMBER,TT_ID, TT_ID_STATUS, TT_DATE) VALUES (:BATCH_NUMBER, :TT_ID, :TT_ID_STATUS,:TT_DATE)</db:sql>
		</db:bulk-insert>
				<error-handler >
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="a0f7e2bc-999e-4804-8526-14b2b31af043" >
						<logger level="ERROR" doc:name="Log Error" doc:id="45e4bd97-89e6-4a47-b0e1-942dc162175c" message="#[error.detailedDescription]"/>
					</on-error-continue>
				</error-handler>
			</try>
		</foreach>
		<logger doc:id="2e231e28-bd6f-4667-9a77-32465b16f18d" doc:name="Log Rows inserted" level="INFO" message='#["Inserted Rows in to table:" ++ sizeOf(payload)]'/>
	</flow>
	<flow name="Project-Status-Get-maxLastRunDateSub-ttid_Flow" doc:id="cd81cf60-5967-4dfb-a00d-0512f7ec5f6c" >
		<logger level="INFO" doc:name="Log reading LastRunDate" doc:id="7cdb2c4a-9d1e-4735-b265-2407272d9e5a" message="---------------------Reading max LastRunDate-------------------------"/>
		<set-variable value='#[vars.ListOfLastUpdatedDate[0].date as LocalDateTime {format: "yyyy-MM-dd HH:mm:ss"} as String {format: "dd-MM-yyyy HH:mm:ss"}]' doc:name="Set lastUpdateDate" doc:id="70a37056-d181-4523-89d7-613a1621db15" variableName="lastUpdateDate"/>
		<set-variable value="#[sizeOf(vars.ListOfLastUpdatedDate)]" doc:name="Set totalRecords" doc:id="0beed5ae-b6c8-47c5-afe7-f5b633d914f7" variableName="totalRecords"/>
		<logger level="INFO" doc:name="Log maxLastUpdatedDate" doc:id="9a5c9b6f-de13-4fd4-acc9-c3dbbb71789b" message='#["maxLastUpdatedDate from TT==&gt;" ++ if(payload[0].maxLastUpdatedDate != null) payload[0].maxLastUpdatedDate else "null"]' />
	</flow>
	</mule>
