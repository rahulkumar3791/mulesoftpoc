<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" 
	xmlns:sftp="http://www.mulesoft.org/schema/mule/sftp"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/sftp http://www.mulesoft.org/schema/mule/sftp/current/mule-sftp.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	<flow name="purchase-requisition-ttid-mainFlow" doc:id="9d06f52c-f47a-49e1-88e7-891240285a6c" >
		<logger level="INFO" doc:name="Logger" doc:id="a288bbef-3cce-4fae-836e-828dffe73a7f" message="###purchase-requistion-ttid flow is started ####"/>
		<ee:transform doc:name="variable Initialize" doc:id="a746042c-e43e-4698-a4c0-af66a74bb8a0" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="ip" ><![CDATA[server.ip as String default "0.0.0.0"]]></ee:set-variable>
				<ee:set-variable variableName="flowName" ><![CDATA["TT_PR_DETAILS"]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Purchase-Requistion-ttid-MainLogicFlow" doc:id="cefd35dd-cdab-4b06-8dbf-4293c9ff70a4" name="Purchase-Requistion-ttid-MainLogicFlow" />
		<logger level="INFO" doc:name="Logger" doc:id="ecad3338-67dd-44ca-ab91-27513062b8c1" message="###purchase-requistion-ttid flow is Completed ####"/>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="0face82f-7db4-4bce-9995-ebb6debec773" type="ANY">
				<set-variable value="#[error.detailedDescription]" doc:name="Set errorMsg" doc:id="4894fdb5-e62b-4e07-bd8d-2f2f3366506b" variableName="errorMsg"/>
				<logger level="INFO" doc:name="Error Log" doc:id="67e2b8df-8342-4479-bea9-8119b53738d6" message="#[vars.errorMsg]"/>
				<set-variable value='#["Failed"]' doc:name="Set Status" doc:id="6ba6d45d-fa1a-4b3a-afc1-099b85826a2e" variableName="status"/>
				<ee:transform doc:name="Email-Audit Payload" doc:id="0b10f922-f7a0-4a4b-8d46-45501cc1b4a0" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
   
   "service": p('current.project.name'),
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":p('interface.id.purchase.requisition.ttid') ,
   "interface_type": p('current.project.type'),
   "requester_ip" : vars.ip,
   "data": {
   	      "status": vars.status,
   	       "flowName": "Purchase requisition LineId : Oracle to TARANTULA",
          "error" : vars.errorMsg
         }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="send-email-audit-Flow" doc:id="13755d4f-015f-447c-aa19-9211f8df9607" name="send-email-audit-Flow"/>
			</on-error-propagate>
		</error-handler>
	</flow>
	<flow name="Purchase-Requistion-ttid-MainLogicFlow" doc:id="f8dd7cf8-9793-4052-9e9e-7a055df42f1e" >
		<set-variable value="#[attributes.queryParams.LineId]" doc:name="Set LineId" doc:id="98f01211-fbd9-4aa1-94ed-348215e6e269" variableName="LineId" />
		<set-payload value="#[vars.LineId]" doc:name="Set Payload" doc:id="5e7328a2-0dd6-4106-88e3-dd04486a7975" />
		<choice doc:name="Choice" doc:id="6796550a-6a16-4191-a899-fa9a7623b684" >
			<when expression='#[(payload == null or payload == "")]'>
				<logger level="INFO" doc:name="Logger" doc:id="36a664fc-0adb-406d-b728-eb57ac3faf83" message="############Provide a LineId to process data #########"/>
				<set-payload value='#[output application/json --- { "LineId": "Provide a LineId required parameter to process data"}]' doc:name="Set Payload" doc:id="de94b687-c250-42d7-9624-c6f279c456c7" />
			</when>
			<otherwise >
				<flow-ref doc:name="Purachese-Requisition-ReadFromOracle-ttid-subFlow" doc:id="2371fe09-0bd9-4a76-a900-44ca421caa87" name="Purachese-Requisition-ReadFromOracle-ttid-subFlow" />
				<choice doc:name="Choice" doc:id="d498cd2d-5e21-4e30-8228-c14ee7e6322a">
					<when expression="#[sizeOf(payload) &gt; 0]">
						<set-variable value="#[0]" doc:name="Init totalRecords" doc:id="cef63057-334b-4291-a1ea-ac3daa569414" variableName="totalRecords"/>
						<flow-ref doc:name="Purachese-Requisition-write-to-TT-ttid-subFlow" doc:id="2fc35bc6-7979-4c75-bbba-125772338889" name="Purachese-Requisition-write-to-TT-ttid-subFlow"/>
						<flow-ref doc:name="Purchase-Requisition-Get-maxLastRunDateSub-ttid_Flow" doc:id="bcd060ff-1d58-4148-9cf9-7dbcd250eddf" name="Purchase-Requisition-Get-maxLastRunDateSub-ttid_Flow" />
					</when>
					<otherwise >
						<logger level="INFO" doc:name="Logger" doc:id="b317e62b-9013-4f7a-a91e-78c45af5d074" message="###########no record found########"/>
					</otherwise>
				</choice>
				<choice doc:name="Choice" doc:id="b5f2e736-37f1-4417-9efa-5feadabc0e49">
					<when expression="#[sizeOf(vars.totalRecords) &gt; 0]">
						<set-variable value='#["success"]' doc:name="Set Status" doc:id="d2c62da9-277f-4cd2-85d3-02ff528d3af9" variableName="status" />
						<ee:transform doc:name="Email Audit Payload" doc:id="90f839bb-ee0e-4691-844e-6aa60e2b7f44">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
   
   "service": p('current.project.name'),
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":p('interface.id.purchase.requisition.ttid') ,
   "interface_type": p('current.project.type'),
   "requester_ip" : vars.ip,
   "data": {
   	      "status": vars.status,
   	     "flowName": "Purchase requisition LineId: Oracle to TARANTULA",
          "recordsProcessed" : vars.totalRecords,
          "currentLastRunDate" : vars.lastUpdateDate,
          "batchNumber": vars.batchDetails.batchNumber
         }
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
						<flow-ref doc:name="send-email-audit-Flow" doc:id="5b5a53c4-62a3-48b8-a1ff-c67f395f6ab2" name="send-email-audit-Flow" />
					</when>
					<otherwise >
						<logger level="INFO" doc:name="Logger" doc:id="de6ce754-706d-4e31-910f-ac020cda96f5" message="############## Lined No record inserted in TT DB #############"/>
					</otherwise>
				</choice>
			</otherwise>
		</choice>
	</flow>
	<flow name="Purachese-Requisition-ReadFromOracle-ttid-subFlow" doc:id="56f0a171-8f27-49de-b6c3-403cfba0cf8f" >
		<db:select doc:name="Read Data from Oracle" doc:id="b9641965-6ef7-4b20-aca3-5cafa641d521" config-ref="Oracle_Configuration">
				<db:sql>SELECT
    PR.PR_HEADER_ID, 
    PR.PR_NUMBER,
    PR.PR_STATUS, 
    PR.PR_DESCRIPTION,TTID, 
    PR.PR_LINE_ID,
    PR.PR_LINE_NUMBER,
    PR.PR_LINE_STATUS,
    PR.ITEM_CODE, 
    PR.ITEM_DESCRIPTION, 
    DECODE(PR.ITEM_CATEGORY, 'Airconditioner' , DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'Battery Bank', 
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'DG',
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'Shelter' , 
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'SMPS' , 
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    'TOWER' , 
    DECODE(LK.ITEM_CODE, null,PR.ITEM_CATEGORY||'-Others',PR.ITEM_CATEGORY),
    PR.ITEM_CATEGORY) &quot;ITEM_CATEGORY&quot;,
    PR.UOM_CODE, 
    to_char(PR.NEED_BY_DATE,'yyyy-mm-dd HH24:MI:SS') &quot;NEED_BY_DATE&quot;,
    PR.QUANTITY,
    PRICE, 
    PR.LINE_VALUE ,
    PR.PROJECT_NAME,
    PR.SUPPLIER_NAME,
    to_char(PR.CREATION_DATE,'yyyy-mm-dd HH24:MI:SS') &quot;CREATION_DATE&quot;,
    to_char(PR.LAST_UPDATE_DATE,'yyyy-mm-dd HH24:MI:SS') &quot;LAST_UPDATE_DATE&quot;,
    PR.PO_NUMBER,
    PR.PO_STATUS,
    PR.MO_NUMBER, 
    PR.MO_STATUS
    FROM XXATC.ATC_PO_IND_SVCS_PR_TT_V PR 
    LEFT JOIN XXATC.ATC_IND_ITEM_CODE_LOOKUP LK
    ON PR.ITEM_CODE = LK.ITEM_CODE
	WHERE PR.PR_LINE_ID = :LineId</db:sql>
				<db:input-parameters><![CDATA[#[{
  "LineId" : vars.LineId
  
}]]]></db:input-parameters>
			</db:select>
		<ee:transform doc:name="Transform Message" doc:id="53566978-601d-4309-9a6b-8ca8fe9aa398">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
payload map (payload01 , indexOfPayload01) -> {
		PR_HEADER_ID		:	payload01.PR_HEADER_ID,
		PR_NUMBER			: 	payload01.PR_NUMBER,
		PR_STATUS  			:	payload01.PR_STATUS,
		PR_DESCRIPTION  	:	payload01.PR_DESCRIPTION,
		TTID       			:	payload01.TTID,
		PR_LINE_ID 			:	payload01.PR_LINE_ID,
		PR_LINE_NUMBER   	:	payload01.PR_LINE_NUMBER,
		PR_LINE_STATUS   	:	payload01.PR_LINE_STATUS,
		ITEM_CODE  			:	payload01.ITEM_CODE,
		ITEM_DESCRIPTION 	:	payload01.ITEM_DESCRIPTION,
		ITEM_CATEGORY    	:	payload01.ITEM_CATEGORY,
		UOM_CODE   			:	payload01.UOM_CODE,
		NEED_BY_DATE     	:	payload01.NEED_BY_DATE,
		QUANTITY   			:	payload01.QUANTITY,
		PRICE      			:	payload01.PRICE,
		LINE_VALUE 			:	payload01.LINE_VALUE,
		PROJECT_NAME		: 	payload01.PROJECT_NAME,
		SUPPLIER_NAME    	:	payload01.SUPPLIER_NAME,
		CREATION_DATE    	:	payload01.CREATION_DATE ,
		LAST_UPDATE_DATE 	:	payload01.LAST_UPDATE_DATE,
		PO_NUMBER  			:	payload01.PO_NUMBER,
		PO_STATUS  			:	payload01.PO_STATUS,
		MO_NUMBER  			:	payload01.MO_NUMBER,
		MO_STATUS  			:	payload01.MO_STATUS
}]]></ee:set-payload>
				</ee:message>
			<ee:variables >
				<ee:set-variable variableName="ListOfLastUpdatedDate" ><![CDATA[%dw 2.0
output application/java
---
(payload map ((payload01 , indexOfPayload01) -> {
	date: payload01.LAST_UPDATE_DATE
}) orderBy $.date)]]></ee:set-variable>
			</ee:variables>
			</ee:transform>
	</flow>
	<flow name="Purchase-Requisition-Get-maxLastRunDateSub-ttid_Flow" doc:id="cd81cf60-5967-4dfb-a00d-0512f7ec5f6c" >
		<logger level="INFO" doc:name="Log reading LastRunDate" doc:id="7cdb2c4a-9d1e-4735-b265-2407272d9e5a" message="---------------------Reading max LastRunDate-------------------------"/>
		<set-variable value='#[vars.ListOfLastUpdatedDate[0].date as LocalDateTime {format: "yyyy-MM-dd HH:mm:ss"} as String {format: "dd-MM-yyyy HH:mm:ss"}]' doc:name="Set lastUpdateDate" doc:id="70a37056-d181-4523-89d7-613a1621db15" variableName="lastUpdateDate" />
		<logger level="INFO" doc:name="Log maxLastUpdatedDate" doc:id="9a5c9b6f-de13-4fd4-acc9-c3dbbb71789b" message='#["maxLastUpdatedDate from TT==&gt;" ++ vars.lastUpdateDate]'/>
	</flow>
	<flow name="Purachese-Requisition-write-to-TT-ttid-subFlow" doc:id="f01f968a-72bf-4998-a521-70fafdc0546c" >
		<foreach doc:name="For Each" doc:id="b7482ea9-b216-429f-adcb-11fcc88c6d1f" >
			<try doc:name="Try" doc:id="5d015817-e030-4c3f-8a0e-6249582d357b" transactionalAction="ALWAYS_BEGIN">
			<db:insert doc:name="Insert" doc:id="2bed3036-c4a8-4f80-b981-4c31c55ea973" config-ref="SQL_Server_Database_Config">
				<db:sql>INSERT INTO 
I_PR_PO(BOQId, PRLineId, PRNumber, PRStatus, PRDescription, TTID, PRLineNumber, PRLineStatus, ItemCode, ItemDescription, ItemName, UOMCode, NeedByDate, Quantity, Price, LineValue, ProjectName, Vendor, PONumber, POStatus, MONumber, MOStatus, CreationDate, LastUpdateDate)
VALUES (:PR_HEADER_ID,:PR_LINE_ID,:PR_NUMBER,:PR_STATUS,:PR_DESCRIPTION,
:TTID,:PR_LINE_NUMBER,:PR_LINE_STATUS,:ITEM_CODE,:ITEM_DESCRIPTION,
:ITEM_CATEGORY,:UOM_CODE,:NEED_BY_DATE,:QUANTITY,:PRICE,:LINE_VALUE,
:PROJECT_NAME,:SUPPLIER_NAME,:PO_NUMBER,:PO_STATUS,:MO_NUMBER,
:MO_STATUS,:CREATION_DATE,:LAST_UPDATE_DATE)</db:sql>
				<db:input-parameters><![CDATA[#[{
"PR_HEADER_ID" : payload.PR_HEADER_ID,
"PR_LINE_ID" : payload.PR_LINE_ID,
"PR_NUMBER"  : payload.PR_NUMBER,
"PR_STATUS"  : payload.PR_STATUS,
"PR_DESCRIPTION" : payload.PR_DESCRIPTION,
"TTID" : payload.TTID,
"PR_LINE_NUMBER" : payload.PR_LINE_NUMBER,
"PR_LINE_STATUS" : payload.PR_LINE_STATUS,
"ITEM_CODE" : payload.ITEM_CODE,
"ITEM_DESCRIPTION" : payload.ITEM_DESCRIPTION,
"ITEM_CATEGORY" : payload.ITEM_CATEGORY,
"UOM_CODE" : payload.UOM_CODE,
"NEED_BY_DATE" : payload.NEED_BY_DATE,
"QUANTITY" : payload.QUANTITY,
"PRICE" : payload.PRICE,
"LINE_VALUE" : payload.LINE_VALUE,
"PROJECT_NAME" : payload.PROJECT_NAME,
"SUPPLIER_NAME" : payload.SUPPLIER_NAME,
"PO_NUMBER" : payload.PO_NUMBER,
"PO_STATUS" : payload.PO_STATUS,
"MO_NUMBER" : payload.MO_NUMBER,
"MO_STATUS" : payload.MO_STATUS,
"CREATION_DATE" : payload.CREATION_DATE,
"LAST_UPDATE_DATE" : payload.LAST_UPDATE_DATE
}]]]></db:input-parameters>
			</db:insert>
			<set-variable value="#[vars.totalRecords + sizeOf(payload.affectedRows)]" doc:name="Set totalRecords" doc:id="339a74e6-47b7-4ca0-a279-4c4cc4d1b4af" variableName="totalRecords" />
			<error-handler>
				<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="ec04b8ea-ce50-49cf-b51d-4f84ac7913c2">
					<logger level="INFO" doc:name="Logger" doc:id="c6571e56-ff6f-4f15-958d-669f68daed81" message="########### error in inserting data from Oracle to TT via LineId ##############" />
					<logger level="INFO" doc:name="Logger" doc:id="a5b79c99-9b6b-4074-ba66-d771dab4c2e7" message="#[error.detailedDescription]" />
				</on-error-continue>
			</error-handler>
		</try>
		</foreach>
	</flow>
</mule>
