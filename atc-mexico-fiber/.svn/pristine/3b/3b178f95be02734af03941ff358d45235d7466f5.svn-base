<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<flow name="update-sitiosFlow" doc:id="1b68f0a3-8999-4d92-8dfe-abd3cd416325" >
		<logger level="INFO" doc:name="Flow Started" doc:id="5d758de5-72b3-40b5-a1e7-ae5ea43c5c43" message="### Sitios Flow is started ####"/>
		<flow-ref doc:name="sitios-count-flow" doc:id="dc4a2f01-e9c2-446e-8f77-4cd1aaa3c39a" name="sitios-count-flow"/>
		<set-variable value="sitios" doc:name="Set sitios" doc:id="87af900f-2f24-4931-8392-e03beecc182f" variableName="sitios"/>
		<set-variable value='#[server.ip as String default "0.0.0.0"]' doc:name="Set IP" doc:id="f682966d-dd7e-45d3-83cd-4b51ebafc7a5" variableName="ip"/>
		<set-variable value="#[[]]" doc:name="Initialize recordlist" doc:id="2d8a2d3e-53f4-4744-91a7-2de8a4c4b1ea" variableName="recordlist"/>
		<set-variable value="success" doc:name="Set Status" doc:id="34710073-c4c8-417c-b744-d010564617f4" variableName="status"/>
		<db:select doc:name="Sitios Fetch Records" doc:id="2a99a29a-0962-4c15-abd9-fc61a4543f31" config-ref="CM_Database_Config">
			<db:sql>select ID,NOMBRE,ID_EDIFICIO,DESCRIPCION from cmsys.sitio 
</db:sql>
		</db:select>
		<logger level="INFO" doc:name="Fetch Records Logs" doc:id="774471e9-29b0-428e-a68c-3dcdb0bcfbfc" message='#["SITIOS Total Count fetched from DB : " ++ sizeOf(payload)]'/>
		<choice doc:name="Choice" doc:id="a5bb0b6b-fc57-445e-a73e-6d5e4d75073e" >
			<when expression="#[sizeOf(payload) &gt; 0 and payload != null]">
				<flow-ref doc:name="sitios-data-move-flow" doc:id="5d740b20-5db9-4e8f-ac49-e935e62b135f" name="sitios-data-move-flow"/>
				<choice doc:name="Choice" doc:id="65bb8c3e-cb12-42a4-9642-0c5ac0da287e" >
					<when expression="#[p('mail.enable')]">
						<ee:transform doc:name="Email Audit Payload" doc:id="2bd3a30c-e49d-44ea-b62e-f034bf02fc6f">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
   "service": p('current.project.name'),
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":p('sitios.current.project.id') ,
   "interface_type": p('current.project.type') as String ,
   "requester_ip": vars.ip,
   "status": {
         "code": vars.status,
          "id" : null,
          "message": "REQUEST COMPLETE"
     },
     "data": '{"service": " updatesitios",
          "SAMResponse": "Records Inserted Successfully",
          "No. of row updated" : ' ++ vars.insertRowCount ++ ',
          "No. of Failed Records " : ' ++ vars.failedRowCount ++ ',
          "status":  ' ++ vars.status ++ '
         }' 
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
						<flow-ref doc:name="send-email-audit-Flow" doc:id="b6b5ff8c-01f5-44b0-b86c-281cb0eb698d" name="send-email-audit-Flow" />
					</when>
					<otherwise >
						<logger level="INFO" doc:name="Logger" doc:id="3b9fefd3-1a76-495f-a760-9afa3d2d0616" message="################## Sitios Email Flow is turn off ####################"/>
					</otherwise>
				</choice>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="No Record Found" doc:id="0722dfc7-5ca1-42de-b553-bc4123dc2f92" message="##### No Record Found in sitios DB for Processing ########"/>
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="Flow Completed" doc:id="f694df49-d1eb-4e22-9bca-6f3d1dc7615e" message="### Sitios Flow is Completed ####"/>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="ee87d783-3bc4-41fa-a9a6-85417e7be48c" type="ANY">
				<set-variable value="#[error.detailedDescription]" doc:name="Set Error Message" doc:id="69eee010-409e-4242-8ab1-866eafa5d108" variableName="errorMsg"/>
				<set-variable value="Failed" doc:name="Set Status" doc:id="3a9d4297-d93f-4eda-9721-1ccd643e7476" variableName="status"/>
				<logger level="INFO" doc:name="Error Logs" doc:id="27f90fb3-eb71-4d4f-a533-919590de052a" message='#["Error in update-sitiossFlow : " ++ vars.errorMsg]'/>
				<ee:transform doc:name="Email Audit Payload" doc:id="8ebf71c2-69ec-435b-9538-e79a74f7ae32" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
   
   "service": p('current.project.name'),
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":p('sitios.current.project.id') ,
   "interface_type": p('current.project.type'),
    "requester_ip": vars.ip,
   "status": {
         "code": vars.status,
         "message":vars.errorMsg default "ERROR",
    },
    "data": '{
          "service": "updatesitios",
          "SAMResponse": "Records not Inserted",
          "status": ' ++ vars.status ++ ' ,
          "Error" : ' ++ vars.errorMsg ++ '
         }'

}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="send-email-audit-Flow" doc:id="d45d609d-d095-4122-baf2-afd99562b523" name="send-email-audit-Flow"/>
			</on-error-propagate>
		</error-handler>
	</flow>
	<flow name="sitios-data-move-flow" doc:id="76b68290-4531-48a5-bb23-6555b5b0eb2f" >
		<foreach doc:name="For Each" doc:id="f31e4432-6326-45c6-b8df-24b01259c369" collection="#[payload]"> 
			<set-variable value='#[output application/java --- (vars.recordlist default []) + ({"ID" : payload.ID  , "NOMBRE": payload.NOMBRE  default "","ID_EDIFICIO": payload.ID_EDIFICIO  ,"DESCRIPCION": payload.DESCRIPCION default ""})]' doc:name="Add list" doc:id="2114f188-a30a-4103-a125-d5cb4615b075" variableName="recordlist" /> 
	  </foreach>
		<set-variable value="#[0]" doc:name="Initialize insertRowCount" doc:id="9699033a-bed9-40b9-a7c2-3b563f5780ed" variableName="insertRowCount"/>
		<set-variable value="#[0]" doc:name="Initialize failedRowCount" doc:id="22e0b8a3-d578-452a-8c47-ee53baf16755" variableName="failedRowCount"/>
		<set-payload value="#[%dw 2.0
import * from dw::core::Arrays
output application/java
---

vars.recordlist default [] divideBy p('sitios.bulk.update.batch.size')]" doc:name="Split List" doc:id="0448c303-bf2d-42bc-8a8f-7053e299677e" />
		<foreach doc:name="For Each" doc:id="b0b79ef7-45bc-42e0-bee1-a1a23267eadd">
					<set-variable value="#[(payload.ID reduce ( (v,k=&quot;&quot;) -&gt; k++ v++ ','))[0 to -2]  default &quot;None&quot;]" doc:name="Set ID" doc:id="5ae98b17-c070-4c3f-8202-8fae03c53d33" variableName="tableID"/>
			<try doc:name="Try" doc:id="0fea45a8-91cd-4607-b58c-119f48c0c7b5" transactionalAction="ALWAYS_BEGIN">
				
				<db:bulk-insert doc:name="Bulk insert" doc:id="8fc102d9-ba77-4960-b85b-76962c952d95" config-ref="SAM_Database_Config">
				<db:sql>insert into SAM20.SAM.sitios(ID,NOMBRE,ID_EDIFICIO,DESCRIPCION) values(:ID, :NOMBRE, :ID_EDIFICIO, :DESCRIPCION)</db:sql>
			</db:bulk-insert>
				<logger level="INFO" doc:name="Records Inserted " doc:id="aca674ef-6bae-43c4-a9e1-42092c4692c3" message='#["SITIOS Total Rows inserted successfully : " ++ sizeOf(payload) ++ ", ID of rows : " ++  vars.tableID]' />
				<set-variable value="#[sizeOf(payload) + vars.insertRowCount]" doc:name="Set insertRowCount" doc:id="25cf4701-6c5f-4086-a9de-847b8bf8d616" variableName="insertRowCount" />
				<error-handler >
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="bb176f32-eefe-46cc-ada4-cde132862320" type="ANY">
						<logger level="INFO" doc:name="Failed Rows" doc:id="f6e4445f-8e9b-4f33-8e0a-c5b84ba1dbc3" message='#["SITIOS FAILED rows : " ++ vars.tableID]'/>
						<logger level="INFO" doc:name="Error logs" doc:id="08f6ec5e-59ff-453c-8488-71c0b0260877" message='#["SITIOS FAILED ROWS REASON : " ++ error.detailedDescription]'/>
						<set-variable value="#[error.detailedDescription]" doc:name="Set errorMsg" doc:id="8fc678b3-dfda-4a08-8277-c03ffddbdd87" variableName="errorMsg"/>
						<set-variable value="Failed" doc:name="Set Status" doc:id="702dd988-048e-47c6-9ee4-c4ed9e82ec4d" variableName="status"/>
						<set-variable value="#[sizeOf(payload) + vars.failedRowCount]" doc:name="Set failedRowCount" doc:id="3ab172c8-7a33-429b-abb1-b4ca396e84cd" variableName="failedRowCount"/>
					</on-error-continue>
				</error-handler>
			</try>
		</foreach>
		<logger level="INFO" doc:name="Success Failed Count" doc:id="efa0a7cc-ec36-4cfb-bbb5-8901a307dc2f" message='#["SITIOS FAILED COUNTS :: " ++ vars.failedRowCount ++ " , SITIOS SUCCESS COUNTS : " ++ vars.insertRowCount]'/>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="3201fc5d-5caa-4aa8-94a4-5c1cc0fcd92e" >
				<set-variable value="#[error.detailedDescription]" doc:name="Set errorMsg" doc:id="8244bfd8-1ab3-434d-8766-618b650e6680" variableName="errorMsg" />
				<set-variable value="Failed" doc:name="Set Status" doc:id="989e4214-b02c-4be6-9e71-e4ef95e6e72c" variableName="status" />
				<logger level="INFO" doc:name="Error Logs" doc:id="93a5619a-cfe3-4f35-b046-e0606c4f335f" message='#["SITIOS Error in sitios-data-move-flow : " ++ vars.errorMsg]' />
				<flow-ref doc:name="update-sitios-error_flow" doc:id="c3ff5cd3-5107-4795-9afa-a45596e97929" name="update-sitios-error_flow" />
			</on-error-propagate>
		</error-handler>
	</flow>
	<flow name="sitios-count-flow" doc:id="e6cbb3ce-aaab-4fd1-8def-64e26fd87803">
		<db:select doc:name="Get Count" doc:id="e59af437-471e-4c29-8c22-29c473d25ac0" config-ref="SAM_Database_Config">
			<db:sql>select ID from SAM20.SAM.sitios</db:sql>
		</db:select>
		<choice doc:name="Check Table Empty or Not" doc:id="c61724a4-ca30-4f40-ae20-7ff3a05aa07f">
			<when expression="#[sizeOf(payload) &gt; 0]">
				<db:delete doc:id="9695263c-afdd-49d0-b674-c674c646a498" doc:name="Delete Records" config-ref="SAM_Database_Config">
					<db:sql>delete from SAM20.SAM.sitios</db:sql>
				</db:delete>
			</when>
			<otherwise>
				<logger level="INFO" doc:name="Logger" doc:id="96d29db9-312c-4ccf-a234-244e66fca25b" message="##### SITIOS No data in sitio table ####" />
			</otherwise>
		</choice>
		<error-handler >
			<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="e27fa111-23ab-4a26-91ff-5a12a6783a63" >
				<set-variable value="#[error.detailedDescription]" doc:name="Set Error Message" doc:id="7eaf5cb8-80d5-48ce-8799-f23a2651c879" variableName="errorMsg"/>
				<set-variable value="Failed" doc:name="Set Status" doc:id="382afcee-2a87-4d6f-b45d-1105121cac77" variableName="status"/>
				<logger level="INFO" doc:name="Error Logs" doc:id="4464b415-501c-49a3-926a-a9ee2fedfbfa" message='#["SITIOS Error in get-count-flow ::: " ++ vars.errorMsg]'/>
				<flow-ref doc:name="update-sitios-error_flow" doc:id="5ef2b48f-e2b4-478a-88f2-9c77c53f541d" name="update-sitios-error_flow"/>
			</on-error-propagate>
		</error-handler>
	</flow>
	<flow name="update-sitios-error_flow" doc:id="7a2317df-deba-4cc8-aa88-db0cb8dd7346" >
		<choice doc:name="Choice" doc:id="62e8cf36-c98e-4473-9f11-9c6433e7098d" >
			<when expression="#[p('mail.enable')]">
				<ee:transform doc:name="Email Audit Payload" doc:id="78c59419-7ebb-4b35-b8c2-4bd32e1a2f35">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
   
   "service": p('current.project.name'),
   "timestamp": now() as String {format: "dd-mm-yyyy'T'hh:mm:ss"},
   "interface_number":p('sitios.current.project.id') ,
   "interface_type": p('current.project.type'),
    "requester_ip": vars.ip,
   "status": {
         "code": vars.status,
         "message":vars.errorMsg default "ERROR",
    },
    "data": '{
          "service": " updatesitios",
          "SAMResponse": "Records not Inserted",
          "status": ' ++ vars.status ++ ',
          "Error" : ' ++ vars.errorMsg ++ '
         }'

}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="send-email-audit-Flow" doc:id="788ee131-c085-4f7a-942f-dcf6d237311d" name="send-email-audit-Flow" />
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Logger" doc:id="47cf54bc-6f6e-4819-a748-a76d6c93db46" message="############ Sitios email flow is off ##############"/>
			</otherwise>
		</choice>
	</flow>
</mule>
